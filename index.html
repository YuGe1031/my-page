<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ÊµÖÊ∞¥ÊπæÂàòÂæ∑‰ºê</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    :root {
      --bg-img: url('https://firebasestorage.googleapis.com/v0/b/yuge1031-45725.firebasestorage.app/o/8826455a02017711249cb4ee3f0c3e84.jpg?alt=media&token=b2ee9dc3-d05d-4434-98a2-a1b17b7c784d');
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Microsoft YaHei', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-img) no-repeat center center fixed;
      background-size: cover;
      color: #333;
      min-height: 100vh;
      overflow-x: hidden;
    }
    #mainApp { display: none; }
    #passwordOverlay { display: flex; }
    .edit-box h3 {
      font-size:19px;
      font-weight:600;
      margin-bottom:8px;
      color:#1976d2;
      text-align: center;
    }
    #customTable td {
      padding: 4px 10px;
      text-align: center;
    }
    #customTable input {
      width: 100%;
      min-width: 40px;
      font-size: 15px;
      box-sizing: border-box;
      border: none;
      background: transparent;
      outline: none;
      text-align: center;
      padding: 2px 6px;
    }
    .edit-title-input, .edit-category-select {
      width: 100%;
      box-sizing: border-box;
      font-size: 18px;
      border: 1.5px solid #b8e0ff;
      border-radius: 7px;
      padding: 11px 12px;
      margin-bottom: 6px;
      background: #f8fcff;
      box-shadow: 0 2px 7px #1976d215;
      outline: none;
      transition: border 0.16s;
      text-align: center;
    }
    .edit-category-select, #newCategory, #dataTableCategoryInput {
      font-size: 16px;
      font-weight: bold;
      padding: 10px 16px;
      border-radius: 9px;
      border: 1.5px solid #1976d2;
      background: #f8fcff;
      box-shadow: 0 2px 9px #1976d222;
      outline: none;
      color: #1976d2;
      min-width: 110px;
      margin-bottom: 8px;
      transition: border 0.15s, box-shadow 0.18s;
    }
    .edit-category-select:focus, #newCategory:focus, #dataTableCategoryInput:focus {
      border: 1.5px solid #1de9b6;
      box-shadow: 0 2px 14px #1de9b644;
    }
    main {
      margin: 40px auto;
      max-width: 1200px;
      padding: 32px 18px 30px 18px;
      border-radius: 28px;
      position: relative;
      z-index: 2;
      min-height: 450px;
      box-shadow: 0 8px 36px #1565c01a;
      background: rgba(255,255,255,0.80);
      backdrop-filter: blur(14px) saturate(1.13);
      -webkit-backdrop-filter: blur(14px) saturate(1.13);
    }
    .main-flex {
      display: flex;
      align-items: flex-start;
      gap: 22px;
    }
    .sidebar {
      min-width: 140px;
      max-width: 220px;
      padding: 22px 10px 0 2px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 13px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .filter-btn {
      border-radius: 8px;
      font-size: 15px;
      padding: 11px 0;
      background: #e3f2fd;
      color: #1976d2;
      border: none;
      box-shadow: 0 2px 8px #1976d219;
      cursor: pointer;
      transition: background 0.14s, color 0.12s;
      width: 100%;
      text-align: center;
      user-select: none;
    }
    .filter-btn.active, .filter-btn:hover {
      background: linear-gradient(90deg,#1a73e8 80%, #1de9b6 100%);
      color: #fff;
    }
    .cat-mgr-btn {
      margin-top: 8px;
      padding: 11px 0;
      font-size: 15px;
      border-radius: 10px;
      background: linear-gradient(90deg,#00e2c9 40%,#1976d2 100%);
      color: #fff;
      font-weight: bold;
      border: none;
      box-shadow: 0 2px 10px #1de9b627;
      cursor: pointer;
      width: 100%;
      transition: background 0.16s;
      user-select: none;
    }
    .cat-mgr-btn:hover {
      background: linear-gradient(90deg,#1976d2 50%,#26c6da 100%);
    }
    .main-content {
      flex: 1 1 auto;
      min-width: 0;
    }
    .input-group {
      gap: 14px;
      margin-bottom: 34px;
      justify-content: center;
      display: flex;
      flex-wrap: wrap;
      border-radius: 16px;
      padding: 16px 20px;
      background: rgba(255,255,255,0.86);
      backdrop-filter: blur(7px);
      box-shadow: 0 4px 16px #1de9b610;
      align-items: center;
    }
    .input-group input[type="text"] {
      font-size: 17px;
      border-radius: 13px;
      border: 1.5px solid #b8e0ff;
      box-shadow: 0 2px 12px #b3d8f322;
      padding: 13px 15px;
      background: rgba(255,255,255,0.9);
      transition: border .16s;
      outline: none;
      min-width: 180px;
    }
    .input-group input[type="text"]:focus {
      border: 1.5px solid #1a73e8;
      background: rgba(240,250,255,0.87);
    }
    .input-group button, .input-group select {
      border-radius: 13px;
      font-size: 17px;
      font-weight: bold;
      padding: 13px 22px;
      color: #fff;
      border: none;
      box-shadow: 0 2px 6px #00eaff26;
      cursor: pointer;
      transition: background 0.13s, transform 0.13s;
      background: linear-gradient(90deg, #2196f3 60%, #1de9b6 100%);
      margin-right: 0;
      user-select: none;
    }
    .input-group select {
      border-radius: 13px;
      font-size: 17px;
      font-weight: bold;
      padding: 13px 22px;
      color: #fff;
      border: none;
      background: linear-gradient(90deg, #2196f3 60%, #1de9b6 100%);
      box-shadow: 0 2px 6px #00eaff26;
      margin-right: 0;
      min-width: 120px;
      height: 48px;
      cursor: pointer;
      outline: none;
      appearance: none;
      display: inline-block;
      line-height: 1;
      text-align: center;
      box-sizing: border-box;
    }
    .input-group select:focus,
    .input-group select:hover {
      background: linear-gradient(90deg, #1976d2 60%, #26c6da 100%);
    }
    .input-group button:hover {
      background: linear-gradient(90deg, #1976d2 60%, #26c6da 100%);
      transform: translateY(-1px) scale(1.04);
    }
    .category-input-custom {
      display: none;
      margin-left: 8px;
      font-size: 15px;
      border-radius: 7px;
      border: 1.5px solid #b8e0ff;
      background: #f8fcff;
      padding: 9px 10px;
      outline: none;
      width: 110px;
      box-shadow: 0 2px 7px #1976d215;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(290px,1fr));
      gap: 28px 22px;
      width: 100%;
    }
    .item {
      background: rgba(255,255,255,0.66);
      backdrop-filter: blur(8px) saturate(1.15);
      box-shadow: 0 4px 24px #1976d220, 0 1.5px 3px #1565c012;
      border-radius: 18px;
      min-width: 0;
      width: 100%;
      min-height: 110px;
      padding: 18px 12px 26px 12px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: box-shadow 0.14s, transform 0.13s, background 0.18s;
      cursor: pointer;
      position: relative;
      user-select: none;
    }
    .item:hover {
      box-shadow: 0 8px 28px #2196f330;
      transform: translateY(-2px) scale(1.03);
      background: rgba(236,245,255,0.80);
    }
    .item .title {
      font-weight: bold;
      font-size: 18.5px;
      margin-bottom: 8px;
      text-align: center;
      color: #1565c0;
      word-break: break-word;
      user-select: text;
    }
    .category-badge {
      display: inline-block;
      background: #1de9b6;
      color: #fff;
      font-size: 13px;
      padding: 2px 11px 3px 11px;
      border-radius: 11px;
      margin-bottom: 9px;
      margin-right: 6px;
      text-align: left;
      letter-spacing: 1px;
      font-weight: 500;
      box-shadow: 0 2px 10px #1de9b627;
      user-select: none;
    }
    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .actions button {
      border-radius: 9px;
      font-size: 15px;
      padding: 7px 16px;
      font-weight: 500;
      background: linear-gradient(90deg, #1a73e8 70%, #1de9b6 100%);
      color: #fff;
      border: none;
      box-shadow: 0 2px 6px #00eaff26;
      cursor: pointer;
      transition: background 0.13s, transform 0.13s;
      user-select: none;
    }
    .actions button:hover {
      background: linear-gradient(90deg, #1976d2 60%, #26c6da 100%);
      transform: scale(1.04);
    }
    .edit-modal {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 99;
      background: rgba(33,42,66,0.04);
    }
    .edit-modal.active { display: flex; }
    .edit-box {
      background: rgba(255,255,255,0.98);
      border-radius: 20px;
      box-shadow: 0 8px 38px #1976d225;
      min-width: 320px;
      max-width: 95vw;
      min-height: 220px;
      max-height: 95vh;
      width: auto !important;
      height: auto !important;
      display: flex;
      flex-direction: column;
      gap: 18px;
      overflow: visible !important;
      position: relative;
      padding: 32px 28px 22px 28px;
      transition: width 0.16s, height 0.16s;
    }
    .edit-box h3 {
      font-size:19px;
      font-weight:600;
      margin-bottom:8px;
      color:#1976d2
    }
    .rich-content {
      flex: 1 1 auto;
      min-height: 400px;
      max-height: none;
      width: 100%;
      box-sizing: border-box;
      border:1.5px solid #c5e4ff;
      background:rgba(255,255,255,0.99);
      border-radius:10px;
      font-size:17px;
      padding:13px;
      box-shadow:0 2px 12px #1976d215;
      margin-bottom:10px;
      outline:none;
      line-height:1.6;
      overflow:auto;
      resize: none;
      margin-top: 6px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .rich-content:focus { border: 1.5px solid #1a73e8; background: #f8fcff;}
    .rich-content:empty:before { content: "ËØ∑ËæìÂÖ•ÂÜÖÂÆπ..."; color: #999;}
    .edit-actions {
      display: flex;
      gap: 16px;
      justify-content: flex-end;
    }
    .edit-actions button {
      padding: 8px 22px;
      border-radius: 9px;
      font-size: 15.5px;
      font-weight: 500;
      background: linear-gradient(90deg, #2196f3 60%, #1de9b6 100%);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.13s;
      user-select: none;
    }
    .edit-actions button.cancel { background: #b8b8b8; color: #fff;}
    #dataTableBox {
      width: auto !important;
      height: auto !important;
      max-width: 95vw;
      max-height: 95vh;
      overflow: visible !important;
      min-width: 320px;
    }
    #dataTableWrapper {
      overflow-x: auto;
      max-width: 100vw;
      background: #fafcff;
      border: 1.5px solid #b8e0ff;
      border-radius: 8px;
      padding: 7px;
      margin-bottom: 10px;
    }
    #customTable {
      min-width: 900px;
      border-collapse: collapse;
    }
    #customTable td {
      padding: 6px 12px;
      border: 1px solid #b8e0ff;
      text-align: center;
      max-width: 340px;
      white-space: pre-wrap;
      word-break: break-word;
      box-sizing: border-box;
    }
    #customTable input {
      width: 100%;
      min-width: 40px;
      font-size: 15px;
      border: none;
      background: transparent;
      outline: none;
      text-align: center;
      padding: 2px 6px;
      box-sizing: border-box;
    }
    @media (max-width:900px) {
      main { padding: 4vw 2vw; }
      .main-flex { flex-direction: column; }
      .sidebar {
    flex-direction: row !important;
    max-width: 100%;
    min-width: 0;
    padding: 6px 4px;
    overflow-x: visible;       /* ÂèñÊ∂àÊ®™ÂêëÊªöÂä® */
    box-sizing: border-box;
    flex-wrap: wrap;           /* ÂÖÅËÆ∏Êç¢Ë°å */
    gap: 8px;
  }
      .filter-group {
    flex-direction: row !important;
    gap: 8px;
    display: flex;
    flex-wrap: wrap;           /* ÂÖÅËÆ∏Êç¢Ë°å */
    white-space: normal;       /* ÂèñÊ∂à nowrap */
  }
      .filter-btn, .cat-mgr-btn {
    flex: 0 1 auto;            /* ÂÆΩÂ∫¶Ëá™Âä®ÔºåÂÖÅËÆ∏Áº©Â∞è */
    width: auto !important;
    max-width: 45vw;           /* ÊúÄÂ§ßÂÆΩÂ∫¶ÔºåÈò≤Ê≠¢ÊíëÁ†¥Â±èÂπï */
    padding: 8px 14px;
    font-size: 14px;
    white-space: normal;       /* ÂÖÅËÆ∏Êç¢Ë°å */
    box-sizing: border-box;
  }
      .cat-mgr-btn {
    margin-top: 0;
    font-weight: bold;
  }
      .container { gap: 18px 7px; }
  .item { min-width: 130px; }
  .edit-box { min-width: 0; padding: 12px 3vw 10px 3vw; }
}
    @media (max-width:600px) {
      .edit-box { padding: 7px 1vw 9px 1vw;}
      .input-group { padding: 9px 2vw; }
      .item { padding: 7px 2vw 10px 2vw; }
      main { border-radius: 0; margin: 0; }
      header { border-radius: 0 0 18px 18px; }
      .container { grid-template-columns: 1fr; }
      #dataTableWrapper {
        overflow-x: auto;
        width: 100%;
        max-width: 100vw;
      }
      #customTable {
        min-width: 1000px;
        width: max-content;
      }
      #customTable td {
        padding: 4px 10px;
        text-align: center;
        max-width: 340px;
        white-space: pre-wrap;
        word-break: break-word;
        box-sizing: border-box;
      }
      #customTable input {
        width: 100%;
        min-width: 40px;
        font-size: 15px;
        border: none;
        background: transparent;
        outline: none;
        text-align: center;
        padding: 2px 6px;
        box-sizing: border-box;
      }
    }
    #passwordOverlay {
      position: fixed;
      z-index: 9999;
      width: 100vw;
      height: 100vh;
      top: 0; left: 0;
      background: var(--bg-img) no-repeat center center fixed;
      background-size: cover;
      backdrop-filter: blur(7px) brightness(1.08);
      background-color: rgba(34, 85, 170, 0.11);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background-color 0.4s;
      animation: fadeInBg 1.2s cubic-bezier(.22,.68,.51,1.16);
      padding: 0 16px;
    }
    #passwordOverlay h3 {
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 2px;
      color: #e3f2fd;
      text-shadow: 0 4px 16px #1565c0cc, 0 2px 8px #fff6;
      margin-bottom: 18px;
      user-select: none;
    }
    #passwordOverlay label {
      display: none; /* Áî®‰∫éÊó†ÈöúÁ¢çÂ±èÂπïÈòÖËØªÂô® */
    }
    #passwordOverlay input, #passwordOverlay button {
      box-shadow: 0 4px 32px rgba(33,150,243,0.15);
      background: rgba(255,255,255,0.85);
      border: 1.5px solid #61aefb;
      border-radius: 10px;
      font-size: 18px;
      margin-bottom: 12px;
      margin-top: 0;
      user-select: text;
    }
    #passwordOverlay input {
      padding: 10px 16px;
      width: 90vw;
      max-width: 260px;
      min-width: 120px;
    }
    #passwordOverlay button {
      padding: 10px 38px;
      font-size: 18px;
      font-weight: bold;
      background: linear-gradient(90deg, #2196f3 60%, #1de9b6 100%);
      color: #fff;
      border: none;
      box-shadow: 0 2px 16px #00eaff30;
      transition: background 0.18s, transform 0.15s;
      cursor: pointer;
      width: 90vw;
      max-width: 260px;
      min-width: 120px;
      user-select: none;
    }
    #passwordOverlay button:hover {
      background: linear-gradient(90deg, #1976d2 40%, #26c6da 100%);
      transform: translateY(-1px) scale(1.03);
    }
    #errorHint {
      margin-top: 10px;
      font-size: 16px;
      color: #f44336;
      font-weight: bold;
      text-shadow: 0 2px 8px #fff6;
      user-select: none;
    }
    .cat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 8px;
      transition: background 0.16s;
      margin-bottom: 6px;
      cursor: pointer;
      user-select: none;
    }
    .cat-item:hover {
      background: #e3f2fd80;
    }
    .cat-name {
      flex: 1 1 auto;
      word-break: break-word;
      font-size: 16px;
      color: #1976d2;
      font-weight: 500;
      user-select: text;
    }
    .cat-count {
      font-size: 13px;
      color: #666;
      background: #e0f7fa;
      border-radius: 10px;
      padding: 2px 8px;
      margin-right: 4px;
      user-select: none;
    }
    .cat-btn {
      background: none;
      border: none;
      font-size: 17px;
      color: #1976d2;
      padding: 3px 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.13s;
      user-select: none;
      line-height: 1;
    }
    .cat-btn:hover {
      background: #e3f2fd;
    }
    .cat-btn.del {
      color: #e53935;
    }
    .cat-btn.del:hover {
      background: #ffcdd2;
    }
    /* header Ê†∑ÂºèÂ¢ûÂº∫ */
    header {
      position: relative;
      left: 50%;
      width: 100vw;
      min-width: 100vw;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.78);
      box-shadow: 0 6px 24px #1976d215;
      border-radius: 0 0 28px 28px;
      padding: 34px 0 32px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      box-sizing: border-box;
      user-select: none;
    }
    header span {
      color: #1976d2;
      font-size: 2.4rem;
      font-weight: bold;
      text-shadow: 0 2px 8px #fff, 0 8px 20px #b0e0ff66;
      letter-spacing: 2px;
    }
    .cool-title {
      position: relative;
      display: inline-block;
      padding: 8px 36px;
      font-size: 2.7rem;
      font-weight: 900;
      letter-spacing: 3px;
      color: #fff;
      background: rgba(25, 118, 210, 0.65);
      border-radius: 18px;
      box-shadow:
        0 0 24px rgba(29, 233, 182, 0.7),
        0 0 48px rgba(33, 150, 243, 0.8);
      cursor: pointer;
      user-select: none;
      transition: transform 0.22s cubic-bezier(.32,1.56,.42,.87);
      overflow: hidden;
      background-image: linear-gradient(90deg,#1de9b6 0%, #2196f3 50%, #ffea00 80%, #ff48fb 100%);
      background-size: 200% 200%;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: cool-title-gradient 6s ease-in-out infinite, cool-title-glow 2.2s linear infinite;
      text-shadow:
        0 0 16px #22e3ffcc,
        0 0 28px #1976d299,
        0 2px 12px #fff;
      filter: brightness(1.25) saturate(1.23);
    }
    .cool-title:hover {
      transform: scale(1.07) rotate(-1deg);
      filter: brightness(1.35) saturate(1.6);
      animation-duration: 1.2s;
      background-image: linear-gradient(90deg, #26c6da 0%, #1976d2 50%, #ffca28 80%, #ea80fc 100%);
      text-shadow:
        0 0 30px #1de9b6cc,
        0 0 60px #2196f3bb,
        0 2px 24px #fff;
    }
    @keyframes cool-title-gradient {
      0%   { background-position: 0% 50%; }
      50%  { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes cool-title-glow {
      0%   { text-shadow:0 0 16px #22e3ffcc, 0 0 28px #1976d299, 0 2px 12px #fff; }
      30%  { text-shadow:0 0 30px #00ffea99, 0 0 60px #2196f355, 0 2px 24px #fff; }
      60%  { text-shadow:0 0 45px #ffd600bb, 0 0 24px #ff48fb99, 0 2px 16px #fff; }
      80%  { text-shadow:0 0 30px #1de9b6cc, 0 0 64px #1de9b6cc, 0 2px 28px #fff; }
      100% { text-shadow:0 0 16px #22e3ffcc, 0 0 28px #1976d299, 0 2px 12px #fff; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div id="passwordOverlay" role="dialog" aria-modal="true" aria-labelledby="passwordTitle">
    <h3 id="passwordTitle">ËØ∑ËæìÂÖ•ËÆøÈóÆÂØÜÁ†Å</h3>
    <label for="accessPassword" class="sr-only">ËÆøÈóÆÂØÜÁ†Å</label>
    <input type="password" id="accessPassword" placeholder="ËæìÂÖ•ÂØÜÁ†Å" autocomplete="current-password" />
    <button id="enterBtn" type="button">ËøõÂÖ•</button>
    <p id="errorHint" style="display: none;" role="alert" aria-live="assertive">ÂØÜÁ†ÅÈîôËØØÔºåËØ∑ÈáçËØï</p>
  </div>

  <div id="mainApp" tabindex="-1" aria-hidden="true">
    <header>
      <span class="cool-title">Ê¨¢ËøéÊù•Âà∞‰∏úÂçó‰∫ö</span>
    </header>
    <main>
      <div class="main-flex">
        <aside class="sidebar" aria-label="ÂàÜÁ±ªÁ≠õÈÄâ">
          <div id="categoryFilterGroup" class="filter-group"></div>
          <button type="button" id="openCategoryManagerBtn" class="cat-mgr-btn">ÂàÜÁ±ªÁÆ°ÁêÜ</button>
        </aside>
        <section class="main-content" aria-live="polite">
          <div class="input-group">
            <input type="text" id="newItem" placeholder="ËæìÂÖ•ÈÄâÈ°πÂêçÁß∞" aria-label="Êñ∞Â¢ûÈÄâÈ°πÂêçÁß∞" />
            <div style="display:flex;align-items:center;">
              <select id="newCategory" aria-label="ÈÄâÊã©ÂàÜÁ±ª"></select>
              <input type="text" id="newCategory_customInput" class="category-input-custom" placeholder="Ëá™ÂÆö‰πâÂàÜÁ±ª" maxlength="8" aria-label="Ëá™ÂÆö‰πâÂàÜÁ±ª" />
            </div>
            <button type="button" onclick="addItem()">Ê∑ªÂä†ÈÄâÈ°π</button>
            <button type="button" onclick="openDataTableModal()">Ê∑ªÂä†Êï∞ÊçÆ</button>
            <input type="text" id="searchBox" placeholder="ÊêúÁ¥¢ÈÄâÈ°πÊàñÂÜÖÂÆπ" aria-label="ÊêúÁ¥¢" oninput="searchItems()" />
            <select id="categoryFilter" onchange="filterByCategory()" style="display:none;" aria-hidden="true">
              <option value="">ÂÖ®ÈÉ®ÂàÜÁ±ª</option>
            </select>
          </div>
          <div id="itemList" class="container" role="list"></div>
        </section>
      </div>
    </main>

    <!-- ÁºñËæëÂºπÁ™ó -->
    <div id="editModal" class="edit-modal" tabindex="-1" aria-modal="true" role="dialog" aria-labelledby="editTitleLabel">
      <div class="edit-box" id="editBox">
        <h3 id="editTitleLabel">ÁºñËæëÈÄâÈ°πÂç°</h3>
        <input class="edit-title-input" id="editTitleInput" placeholder="ËØ∑ËæìÂÖ•ÈÄâÈ°πÂç°Ê†áÈ¢ò" aria-label="ÁºñËæëÊ†áÈ¢ò" />
        <div style="display:flex;align-items:center;">
          <select class="edit-category-select" id="editCategoryInput" aria-label="ÁºñËæëÂàÜÁ±ª"></select>
          <input type="text" id="editCategoryInput_customInput" class="category-input-custom" placeholder="Ëá™ÂÆö‰πâÂàÜÁ±ª" maxlength="8" aria-label="ÁºñËæëËá™ÂÆö‰πâÂàÜÁ±ª" />
        </div>
        <div class="rich-content" id="editContent" contenteditable="true" aria-label="ÁºñËæëÂÜÖÂÆπ"></div>
        <div class="edit-actions">
          <button type="button" onclick="saveEdit()">‰øùÂ≠ò</button>
          <button type="button" class="cancel" onclick="closeEdit()">ÂèñÊ∂à</button>
        </div>
      </div>
    </div>

    <!-- Êï∞ÊçÆË°®ÂºπÁ™ó -->
    <div id="dataTableModal" class="edit-modal" tabindex="-1" aria-modal="true" role="dialog" aria-labelledby="dataTableTitleLabel">
      <div class="edit-box" id="dataTableBox">
        <h3 id="dataTableTitleLabel">Ê∑ªÂä†Êï∞ÊçÆÂç°Áâá</h3>
        <input class="edit-title-input" id="dataTableTitleInput" placeholder="ËØ∑ËæìÂÖ•Êï∞ÊçÆÂç°ÁâáÊ†áÈ¢ò" aria-label="Êï∞ÊçÆÂç°ÁâáÊ†áÈ¢ò" />
        <div style="display:flex;align-items:center;">
          <select class="edit-category-select" id="dataTableCategoryInput" aria-label="Êï∞ÊçÆÂç°ÁâáÂàÜÁ±ª"></select>
          <input type="text" id="dataTableCategoryInput_customInput" class="category-input-custom" placeholder="Ëá™ÂÆö‰πâÂàÜÁ±ª" maxlength="8" aria-label="Êï∞ÊçÆÂç°ÁâáËá™ÂÆö‰πâÂàÜÁ±ª" />
        </div>
        <div id="dataTableWrapper">
          <table id="customTable" border="1" style="border-collapse:collapse;"></table>
        </div>
        <div class="edit-actions">
          <button type="button" onclick="saveDataTable()">‰øùÂ≠ò</button>
          <button type="button" class="cancel" onclick="closeDataTable()">ÂèñÊ∂à</button>
        </div>
      </div>
    </div>

    <!-- ÂàÜÁ±ªÁÆ°ÁêÜÂºπÁ™ó -->
    <div id="categoryManagerModal" class="edit-modal" tabindex="-1" aria-modal="true" role="dialog" aria-labelledby="categoryManagerLabel">
      <div class="edit-box" style="min-width:260px;">
        <h3 id="categoryManagerLabel">ÂàÜÁ±ªÁÆ°ÁêÜ</h3>
        <ul id="categoryList" style="list-style:none;padding:0;margin-bottom:16px;"></ul>
        <div style="display:flex;gap:8px;">
          <input type="text" id="newCategoryInput" placeholder="Êñ∞ÂàÜÁ±ªÂêç" style="flex:1 1 auto;padding:9px 12px;font-size:15px;border-radius:7px;border:1.5px solid #b8e0ff;background:#f8fcff;outline:none;" maxlength="8" aria-label="Êñ∞Â¢ûÂàÜÁ±ªÂêçÁß∞" />
          <button id="addCategoryBtn" type="button" style="padding:8px 16px;border-radius:7px;background:linear-gradient(90deg,#1de9b6 30%,#1976d2 100%);color:#fff;font-size:15px;font-weight:bold;">Êñ∞Â¢û</button>
        </div>
        <div class="edit-actions" style="margin-top:18px;">
          <button type="button" onclick="closeCategoryManager()">ÂÖ≥Èó≠</button>
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", function() {

  const CORRECT_PASSWORD = "qwe96300";

  const firebaseConfig = {
    apiKey: "AIzaSyAZFBRN2YfUdSSiCsIy63iMUqwdOqUZO1k",
    authDomain: "yuge1031-45725.firebaseapp.com",
    databaseURL: "https://yuge1031-45725-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "yuge1031-45725",
    storageBucket: "yuge1031-45725.appspot.com",
    messagingSenderId: "131078767676",
    appId: "1:131078767676:web:89418f134456102c9aaf39"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const passwordOverlay = document.getElementById("passwordOverlay");
  const mainApp = document.getElementById("mainApp");
  const errorHint = document.getElementById("errorHint");
  const passwordInput = document.getElementById("accessPassword");
  const enterBtn = document.getElementById("enterBtn");
  const itemList = document.getElementById("itemList");

  let allData = {};
  let allOrder = [];
  let currentCategoryFilter = "";

  // ÂØÜÁ†ÅÈ™åËØÅ
  function checkPassword() {
    if (passwordInput.value === CORRECT_PASSWORD) {
      errorHint.style.display = "none";
      passwordOverlay.style.display = "none";
      mainApp.style.display = "block";
      mainApp.setAttribute("aria-hidden", "false");
      mainApp.focus();
    } else {
      errorHint.style.display = "block";
      passwordInput.focus();
    }
  }
  enterBtn.onclick = checkPassword;
  passwordInput.addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      checkPassword();
    }
  });
  passwordInput.addEventListener("input", () => {
    errorHint.style.display = "none";
  });
  passwordInput.focus();

  // ÂàÜÁ±ªÁÆ°ÁêÜÁõ∏ÂÖ≥
  let CATEGORY_LIST = [];

  function loadCategoryList(callback) {
    db.ref('categories').once('value').then(snapshot => {
      const val = snapshot.val();
      if (Array.isArray(val) && val.length) {
        CATEGORY_LIST = val;
      } else {
        CATEGORY_LIST = ["ÁßëÊäÄËµÑËÆØ","Êï∞ÊçÆÁªüËÆ°","ÊàêÂëò‰ø°ÊÅØ","ÂÖ∂‰ªñ"];
        db.ref('categories').set(CATEGORY_LIST);
      }
      if (typeof callback === "function") callback();
    }).catch(() => {
      CATEGORY_LIST = ["ÁßëÊäÄËµÑËÆØ","Êï∞ÊçÆÁªüËÆ°","ÊàêÂëò‰ø°ÊÅØ","ÂÖ∂‰ªñ"];
      if (typeof callback === "function") callback();
    });
  }

  function saveCategoryList(){
    db.ref('categories').set(CATEGORY_LIST);
  }

  function renderCategorySelect(){
    const selects = [
      {sel:document.getElementById('newCategory'), inp:document.getElementById('newCategory_customInput')},
      {sel:document.getElementById('editCategoryInput'), inp:document.getElementById('editCategoryInput_customInput')},
      {sel:document.getElementById('dataTableCategoryInput'), inp:document.getElementById('dataTableCategoryInput_customInput')}
    ];
    selects.forEach(({sel, inp})=>{
      if(!sel) return;
      const old = sel.value;
      sel.innerHTML = `<option value="">ÈÄâÊã©ÂàÜÁ±ª</option>` +
        CATEGORY_LIST.map(c=>`<option value="${c}">${c}</option>`).join('') +
        `<option value="_custom_">Ëá™ÂÆö‰πâ...</option>`;
      sel.value = old || "";
      if(inp) inp.style.display="none";
    });

    // Á≠õÈÄâÂå∫ÊåâÈíÆ
    const filterGroup = document.getElementById('categoryFilterGroup');
    if(filterGroup){
      filterGroup.innerHTML = `<button class="filter-btn" data-value="">ÂÖ®ÈÉ®ÂàÜÁ±ª</button>` +
        CATEGORY_LIST.map(c=>`<button class="filter-btn" data-value="${c}">${c}</button>`).join('');
      const cur = document.getElementById('categoryFilter')?.value || "";
      [...filterGroup.children].forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.value===cur);
        btn.onclick = function(){
          document.getElementById("categoryFilter").value = this.dataset.value;
          filterByCategory();
          [...filterGroup.children].forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
        }
      });
    }

    // ÂêåÊ≠•ÈöêËóèselect
    const sel = document.getElementById('categoryFilter');
    if(sel){
      const val = sel.value;
      sel.innerHTML = `<option value="">ÂÖ®ÈÉ®ÂàÜÁ±ª</option>`+CATEGORY_LIST.map(c=>`<option value="${c}">${c}</option>`).join('');
      sel.value = val || "";
    }
  }

  [
    {sel:'newCategory',inp:'newCategory_customInput'},
    {sel:'editCategoryInput',inp:'editCategoryInput_customInput'},
    {sel:'dataTableCategoryInput',inp:'dataTableCategoryInput_customInput'}
  ].forEach(({sel, inp})=>{
    const select = document.getElementById(sel);
    const input = document.getElementById(inp);
    if (!select || !input) return;
    select.addEventListener('change', function(){
      if(this.value==="_custom_"){
        input.style.display="";
        input.value="";
        input.focus();
      }else{
        input.style.display="none";
      }
    });
    input.addEventListener('keydown', function(e){
      if(e.key==="Enter"){
        const val = input.value.trim();
        if(val && !CATEGORY_LIST.includes(val)){
          CATEGORY_LIST.push(val);
          saveCategoryList();
          renderCategorySelect();
        }
        select.value = val;
        input.style.display = "none";
      }
    });
  });

  // ÂàÜÁ±ªÁÆ°ÁêÜÂºπÁ™óÁõ∏ÂÖ≥
  const openCategoryManagerBtn = document.getElementById("openCategoryManagerBtn");
  openCategoryManagerBtn.onclick = openCategoryManager;

  function openCategoryManager(){
    renderCategoryManager();
    document.getElementById("categoryManagerModal").classList.add("active");
  }
  function closeCategoryManager(){
    document.getElementById("categoryManagerModal").classList.remove("active");
  }
  window.closeCategoryManager = closeCategoryManager;

  function renderCategoryManager() {
    const ul = document.getElementById("categoryList");
    ul.innerHTML = "";
    const fragment = document.createDocumentFragment();
    CATEGORY_LIST.forEach((cat, idx) => {
      let count = 0;
      for (let key in allData) {
        if (allData[key].category === cat) count++;
      }

      const li = document.createElement("li");
      li.className = "cat-item";

      const nameSpan = document.createElement("span");
      nameSpan.className = "cat-name";
      nameSpan.textContent = cat;

      const countSpan = document.createElement("span");
      countSpan.className = "cat-count";
      countSpan.textContent = count;

      li.appendChild(nameSpan);
      li.appendChild(countSpan);

      // ÈáçÂëΩÂêçÊåâÈíÆ
      const renameBtn = document.createElement("button");
      renameBtn.className = "cat-btn";
      renameBtn.title = "ÈáçÂëΩÂêç";
      renameBtn.innerHTML = "‚úèÔ∏è";
      renameBtn.onclick = function (e) {
        e.stopPropagation();
        const val = prompt("ÈáçÂëΩÂêç‰∏∫Ôºö", cat);
        if (!val || val === cat || CATEGORY_LIST.includes(val)) return;
        // Êõ¥Êñ∞ÊâÄÊúâÁõ∏ÂÖ≥Êï∞ÊçÆÂàÜÁ±ª
        for (const key in allData) {
          if (allData[key].category === cat) {
            db.ref('data/' + key).update({ category: val }).catch(e => alert("ÈáçÂëΩÂêçÊó∂Êï∞ÊçÆÂ∫ìÈîôËØØÔºö" + e.message));
          }
        }
        CATEGORY_LIST[idx] = val;
        saveCategoryList();
        renderCategoryManager();
        renderCategorySelect();
      };
      li.appendChild(renameBtn);

      // Âà†Èô§ÊåâÈíÆ
      const delBtn = document.createElement("button");
      delBtn.className = "cat-btn del";
      delBtn.title = "Âà†Èô§";
      delBtn.innerHTML = "üóëÔ∏è";
      delBtn.onclick = function (e) {
        e.stopPropagation();
        if (!confirm(`Âà†Èô§ÂàÜÁ±ª‚Äú${cat}‚ÄùÂêéÔºåÁõ∏ÂÖ≥Êï∞ÊçÆÁöÑÂàÜÁ±ªÂ∞ÜË¢´Ê∏ÖÁ©∫„ÄÇÁ°ÆÂÆöÔºü`)) return;
        for (const key in allData) {
  if (allData[key].category === cat) {
    // Ê∏ÖÁ©∫ÂàÜÁ±ªÂ≠óÊÆµ
    db.ref('data/' + key).update({ category: "" }).catch(e => alert("Âà†Èô§ÂàÜÁ±ªÊó∂Êï∞ÊçÆÂ∫ìÈîôËØØÔºö" + e.message));
  }
}

// ÂÆâÂÖ®Êõ¥Êñ∞ orderÔºå‰øùÁïôÊâÄÊúâ data ‰∏≠Â≠òÂú®ÁöÑ key
db.ref('data').once('value').then(snap => {
  const validKeys = Object.keys(snap.val() || {});
  db.ref('order').once('value').then(orderSnap => {
    const currentOrder = orderSnap.val() || [];
    const newOrder = currentOrder.filter(k => validKeys.includes(k));
    db.ref('order').set(newOrder);
  });
});
        CATEGORY_LIST.splice(idx, 1);
        saveCategoryList();
        renderCategoryManager();
        renderCategorySelect();
      };
      li.appendChild(delBtn);

      fragment.appendChild(li);
    });
    ul.appendChild(fragment);
  }

  document.getElementById("addCategoryBtn").onclick = function(){
    const val = document.getElementById("newCategoryInput").value.trim();
    if(val && !CATEGORY_LIST.includes(val)){
      CATEGORY_LIST.push(val);
      saveCategoryList();
      renderCategoryManager();
      renderCategorySelect();
      document.getElementById("newCategoryInput").value="";
    }
  }

  // ================= Êï∞ÊçÆÈ°πÁõ∏ÂÖ≥ ===================
  function highlightKeyword(str, keyword) {
    if (!keyword) return str;
    const safe = s => s.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
    return str.replace(new RegExp(safe(keyword), 'gi'), m => `<span style="background:#ffe082;color:#d32f2f;border-radius:4px;padding:0 2px;">${m}</span>`);
  }

  function renderAllItems(data, order) {
    itemList.innerHTML = "";
    const fragment = document.createDocumentFragment();
    (order || Object.keys(data)).forEach(name => {
      if (data[name] !== undefined) {
        const el = createItemElement(name, data[name]);
        fragment.appendChild(el);
      }
    });
    itemList.appendChild(fragment);
  }

  function getCardCategory(obj) {
    if (typeof obj === "object" && obj.category) return obj.category;
    return "";
  }
  function getCardContent(obj) {
    if (typeof obj === "object" && obj.content !== undefined) return obj.content;
    return obj;
  }

  function createItemElement(itemName, obj = {}) {
    let content = getCardContent(obj);
    let category = getCardCategory(obj);

    const container = document.createElement("div");
    container.className = "item";
    container.dataset.name = itemName;
    container.setAttribute("role", "listitem");
    container.tabIndex = 0;
    container.onclick = () => openEditor(itemName);
    container.addEventListener('keydown', e => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        openEditor(itemName);
      }
    });
    container.addEventListener('click', (e) => {
      if(e.target.tagName === 'BUTTON') e.stopPropagation();
    });

    if (category) {
      const catDiv = document.createElement("div");
      catDiv.className = "category-badge";
      catDiv.textContent = category;
      catDiv.style.margin = "0 auto 7px auto";
      catDiv.style.background = "linear-gradient(90deg, #1976d2 65%, #1de9b6 100%)";
      catDiv.style.fontWeight = "bold";
      catDiv.style.fontSize = "15.5px";
      catDiv.style.boxShadow = "0 2px 10px #1565c036";
      catDiv.style.color = "#fff";
      container.appendChild(catDiv);
    }

    const title = document.createElement("div");
    title.className = "title";
    const keyword = document.getElementById("searchBox")?.value.trim();
    if (keyword) {
      title.innerHTML = highlightKeyword(itemName, keyword);
    } else {
      title.textContent = itemName;
    }
    container.appendChild(title);

    const actions = document.createElement("div");
    actions.className = "actions";
    const btnEdit = document.createElement("button");
    btnEdit.type = "button";
    btnEdit.textContent = "‰øÆÊîπ";
    btnEdit.onclick = () => openEditor(itemName);
    const btnDel = document.createElement("button");
    btnDel.type = "button";
    btnDel.textContent = "Âà†Èô§";
    btnDel.onclick = (e) => deleteItem(itemName, e);
    actions.appendChild(btnEdit);
    actions.appendChild(btnDel);
    container.appendChild(actions);

    return container;
  }

function addItem() {
  const name = document.getElementById("newItem").value.trim();
  if (!name) return alert("ËØ∑ËæìÂÖ•ÂêçÁß∞");

  let catSel = document.getElementById("newCategory");
  let cat = catSel.value;
  if (cat === "_custom_") {
    cat = document.getElementById("newCategory_customInput").value.trim();
    if (cat && !CATEGORY_LIST.includes(cat)) {
      CATEGORY_LIST.push(cat);
      saveCategoryList();
      renderCategorySelect();
    }
  }

  db.ref('data/' + name).once("value").then(snapshot => {
    if (snapshot.exists()) return alert("ËØ•ÈÄâÈ°πÂ∑≤Â≠òÂú®ÔºÅ");

    // ‚úÖ ÂÖàÂÜôÂÖ• dataÔºåÂÜçÂÜôÂÖ• orderÔºàÈ°∫Â∫èÂæàÈáçË¶ÅÔºâ
    db.ref('data/' + name).set({ content: "", category: cat }, err => {
      if (err) return alert("ÂÜôÂÖ•Â§±Ë¥•ÔºåËØ∑ÈáçËØï");

      // ÁÑ∂ÂêéÂÜçÊ∑ªÂä†Âà∞ order ‰∏≠ÔºàÂÆâÂÖ®ÂÜôÊ≥ïÔºâ
      db.ref('order').transaction(currentOrder => {
  if (!Array.isArray(currentOrder)) currentOrder = [];
  if (!currentOrder.includes(name)) currentOrder.push(name);
  return currentOrder;
});


      // ‚úÖ Ê∏ÖÁ©∫Ë°®Âçï
      document.getElementById("newItem").value = "";
      catSel.value = "";
      document.getElementById("newCategory_customInput").style.display = "none";
    });
  });
}
  window.addItem = addItem;
  window.deleteItem = deleteItem;

  let currentEditName = "";

  function openEditor(name) {
    db.ref('data/' + name).once("value").then(snapshot => {
      const data = snapshot.val() || {};
      if (typeof data === "object" && typeof data.content === "string" && data.content.startsWith("<table")) {
        openDataTableModal(name, data.content);
        return;
      }
      currentEditName = name;
      document.getElementById("editTitleInput").value = name;
      document.getElementById("editCategoryInput").value = data.category || "";
      document.getElementById("editCategoryInput_customInput").style.display = "none";
      document.getElementById("editContent").innerHTML = data.content || "";
      document.getElementById("editModal").classList.add("active");
      setTimeout(() => document.getElementById("editTitleInput").focus(), 100);
    });
  }
  window.openEditor = openEditor;

  function closeEdit() {
    document.getElementById("editModal").classList.remove("active");
  }
  window.closeEdit = closeEdit;

  function saveEdit() {
    const newTitle = document.getElementById("editTitleInput").value.trim();
    let catSel = document.getElementById("editCategoryInput");
    let newCategory = catSel.value;
    if(newCategory === "_custom_"){
      newCategory = document.getElementById("editCategoryInput_customInput").value.trim();
      if(newCategory && !CATEGORY_LIST.includes(newCategory)){
        CATEGORY_LIST.push(newCategory);
        saveCategoryList();
        renderCategorySelect();
      }
    }
    const content = document.getElementById("editContent").innerHTML;
    if (!newTitle) return alert("Ê†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
    let obj = { content, category: newCategory };
    if (newTitle !== currentEditName) {
      db.ref('data/' + currentEditName).remove();
      db.ref('data/' + newTitle).set(obj);
      db.ref('order').once("value").then(snap => {
        const order = (snap.val() || []).map(n => n === currentEditName ? newTitle : n);
        db.ref('order').set(order);
      });
    } else {
      db.ref('data/' + currentEditName).set(obj);
    }
    closeEdit();
  }
function deleteItem(name, e) {
  e?.preventDefault();        // ÈòªÊ≠¢ÈªòËÆ§Ë∑≥ËΩ¨ÊàñË°®ÂçïÊèê‰∫§
  e?.stopPropagation();       // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶ÂèëÂç°ÁâáÁÇπÂáª‰∫ã‰ª∂

  if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ "${name}" ÂêóÔºüÂà†Èô§Âêé‰∏çÂèØÊÅ¢Â§ç„ÄÇ`)) return;

  db.ref('data/' + name).remove();
  db.ref('order').once("value").then(snap => {
    const order = snap.val() || [];
    const newOrder = order.filter(item => item !== name);
    db.ref('order').set(newOrder);
  });
}
  window.saveEdit = saveEdit;

  document.addEventListener('keydown', e => {
    if(document.getElementById("editModal").classList.contains("active") && e.key==="Escape") {
      closeEdit();
    }
  });
  document.getElementById("editModal").addEventListener("click", e => {
    if(e.target === e.currentTarget) closeEdit();
  });

  function searchItems() {
    const keyword = document.getElementById("searchBox").value.trim().toLowerCase();
    let categorySelected = document.getElementById("categoryFilter").value;
    let filtered = {};
    for (let k of allOrder) {
      let obj = allData[k];
      let category = getCardCategory(obj);
      let content = getCardContent(obj) || "";
      if (
        (!categorySelected || category === categorySelected) &&
        (
          k.toLowerCase().includes(keyword) ||
          (typeof content === "string" && content.toLowerCase().includes(keyword))
        )
      ) {
        filtered[k] = obj;
      }
    }
    renderAllItems(filtered, Object.keys(filtered));
    if (Object.keys(filtered).length === 0) {
      itemList.innerHTML = `<div style="grid-column: 1/-1;text-align:center;font-size:1.15em;padding:48px 0;color:#1976d2a0;">
        Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÂÜÖÂÆπÔºåËØ∑Â∞ùËØïÂÖ∂‰ªñÂÖ≥ÈîÆËØç
      </div>`;
    }
  }
  window.searchItems = searchItems;

  function filterByCategory() {
    const selected = document.getElementById("categoryFilter").value;
    currentCategoryFilter = selected;
    const keyword = document.getElementById("searchBox").value.trim().toLowerCase();
    if (!selected && !keyword) {
      renderAllItems(allData, allOrder);
      return;
    }
    let filtered = {};
    for (let k of allOrder) {
      let obj = allData[k];
      let category = getCardCategory(obj);
      let content = getCardContent(obj) || "";
      if (
        (!selected || category === selected) &&
        (!keyword || k.toLowerCase().includes(keyword) ||
         (typeof content === "string" && content.toLowerCase().includes(keyword)))
      ) {
        filtered[k] = obj;
      }
    }
    renderAllItems(filtered, Object.keys(filtered));
    if (Object.keys(filtered).length === 0) {
      itemList.innerHTML = `<div style="grid-column: 1/-1;text-align:center;font-size:1.15em;padding:48px 0;color:#1976d2a0;">
        Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÂÜÖÂÆπÔºåËØ∑Â∞ùËØïÂÖ∂‰ªñÂÖ≥ÈîÆËØç
      </div>`;
    }
  }
  window.filterByCategory = filterByCategory;

  // ÁõëÂê¨Êï∞ÊçÆÂ∫ìÊï∞ÊçÆÊõ¥Êñ∞Âπ∂Ê∏≤Êüì
  db.ref().on("value", snapshot => {
    const val = snapshot.val() || {};
    allData = val.data || {};
    allOrder = val.order || Object.keys(allData);
    loadCategoryList(() => {
      renderCategorySelect();
      if (currentCategoryFilter || document.getElementById("searchBox").value.trim()) {
        filterByCategory();
      } else {
        renderAllItems(allData, allOrder);
      }
    });
  });

  // ÊãñÊãΩÊéíÂ∫è
new Sortable(itemList, {
  animation: 150,
  delay: 2000,
  delayOnTouchOnly: true,
  touchStartThreshold: 3,
  onEnd: function () {
    const newOrder = [...itemList.children].map(div => div.dataset.name);
    db.ref('order').set(newOrder);
  }
});

// ÂÖÅËÆ∏ÁºñËæëÊ°ÜÁ≤òË¥¥ÂõæÁâá
document.getElementById("editContent").addEventListener("paste", function(e) {
  if (e.clipboardData) {
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
      if (items[i].type.indexOf("image") !== -1) {
        const blob = items[i].getAsFile();
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = document.createElement("img");
          img.src = event.target.result;
          img.style.maxWidth = "100%";
          const sel = window.getSelection();
          if (!sel.rangeCount) return;
          const range = sel.getRangeAt(0);
          range.deleteContents();
          range.insertNode(img);
          // ÂÖâÊ†áÁßªÂä®Âà∞ÂõæÁâáÂêéÈù¢
          range.setStartAfter(img);
          range.setEndAfter(img);
          sel.removeAllRanges();
          sel.addRange(range);
        };
        reader.readAsDataURL(blob);
        e.preventDefault();
        return false;
      }
    }
  }
});
  // Êï∞ÊçÆË°®ÂºπÁ™óÁõ∏ÂÖ≥
  let currentDataTableTitle = "";

  function openDataTableModal(name = "", tableHtml = "") {
    document.getElementById("dataTableTitleInput").value = name || "";
    currentDataTableTitle = name || "";
    if (name) {
      db.ref('data/' + name).once("value").then(snapshot => {
        const val = snapshot.val();
        if (typeof val === "object" && val.category) {
          document.getElementById("dataTableCategoryInput").value = val.category;
        } else {
          document.getElementById("dataTableCategoryInput").value = "";
        }
      });
    } else {
      document.getElementById("dataTableCategoryInput").value = "";
    }

    let dataArr = [];
    if (tableHtml) {
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = tableHtml;
      const rows = tempDiv.querySelectorAll("tr");
      rows.forEach(tr => {
        let rowArr = [];
        tr.querySelectorAll("td").forEach(td => {
          rowArr.push((td.textContent || '').replace(/"/g, '&quot;'));
        });
        dataArr.push(rowArr);
      });
    } else {
      for(let i=0;i<10;i++){
        let rowArr = [];
        for(let j=0;j<15;j++) rowArr.push('');
        dataArr.push(rowArr);
      }
    }
    buildTable(dataArr);
    document.getElementById("dataTableModal").classList.add("active");
    document.getElementById("dataTableCategoryInput_customInput").style.display="none";
  }
  window.openDataTableModal = openDataTableModal;

  function buildTable(arr) {
    const colCount = arr[0]?.length || 0;
    let html = "";
    for (let i=0; i<arr.length; i++) {
      html += "<tr>";
      for (let j=0; j<colCount; j++) {
        html += `<td><input type="text" value="${arr[i][j].replace(/"/g,'&quot;')}" oninput="updateTableSumRow()" /></td>`;
      }
      html += "</tr>";
    }
    document.getElementById("customTable").innerHTML = html;
    updateTableSumRow();
  }

  window.updateTableSumRow = function() {
    const trs = document.querySelectorAll("#customTable tr");
    let arr = [];
    let colCount = 0;
    trs.forEach(tr => {
      let row = [];
      tr.querySelectorAll('td input').forEach(inp => row.push(inp.value));
      if (row.length > colCount) colCount = row.length;
      arr.push(row);
    });
    arr = arr.map(row => {
      while(row.length < colCount) row.push("");
      return row;
    });
    // ËÆ°ÁÆóÂêÑÂàóÂíå
    let sumArr = [];
    for (let j=0;j<colCount;j++) {
      let sum = 0, isNumberCol = false;
      for (let i=0;i<arr.length;i++) {
        let val = arr[i][j];
        let num = parseFloat(val);
        if (!isNaN(num) && val !== "") {
          sum += num;
          isNumberCol = true;
        }
      }
      sumArr[j] = isNumberCol ? sum : "";
    }
    // Ê±ÇÂíåË°åÊ∏≤Êüì
    let sumTr = document.getElementById("sumRow");
    if (!sumTr) {
      sumTr = document.createElement("tr");
      sumTr.id = "sumRow";
      sumTr.style.background = "#e3f2fd";
      sumTr.style.fontWeight = "bold";
      document.getElementById("customTable").appendChild(sumTr);
    }
    let sumHtml = "";
    for (let j=0;j<colCount;j++) {
      sumHtml += `<td>${sumArr[j]!=="" ? sumArr[j] : ""}</td>`;
    }
    sumTr.innerHTML = sumHtml;
  };

  function closeDataTable(){
    document.getElementById("dataTableModal").classList.remove("active");
  }
  window.closeDataTable = closeDataTable;

  function saveDataTable(){
    const titleInput = document.getElementById("dataTableTitleInput");
    let title = titleInput.value.trim();
    let catSel = document.getElementById("dataTableCategoryInput");
    let cat = catSel.value;
    if(cat === "_custom_"){
      cat = document.getElementById("dataTableCategoryInput_customInput").value.trim();
      if(cat && !CATEGORY_LIST.includes(cat)){
        CATEGORY_LIST.push(cat);
        saveCategoryList();
        renderCategorySelect();
      }
    }
    if(!title) return alert("Ê†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
    const trs = document.querySelectorAll("#customTable tr");
    let arr = [];
    trs.forEach(tr => {
      if (tr.id === "sumRow") return;
      let row = [];
      tr.querySelectorAll('td input').forEach(inp => row.push(inp.value));
      arr.push(row);
    });
    let tableHtml = "<table border='1' style='border-collapse:collapse'>";
    arr.forEach(row=>{
      tableHtml += "<tr>";
      row.forEach(cell=>{
        tableHtml += `<td style="min-width:40px;padding:3px 8px">${cell?cell:""}</td>`;
      });
      tableHtml += "</tr>";
    });
    tableHtml += "</table>";

    let obj = { content: tableHtml, category: cat };

    if (title !== currentDataTableTitle && currentDataTableTitle) {
      // ÈáçÂëΩÂêçÔºåÂà†Èô§Êóß keyÔºåÂπ∂Êõ¥Êñ∞È°∫Â∫è
      firebase.database().ref('data/' + currentDataTableTitle).remove();
      firebase.database().ref('order').once("value").then(snap => {
        let order = snap.val() || [];
        order = order.map(v => v === currentDataTableTitle ? title : v);
        firebase.database().ref('order').set(order);
      });
    } else {
      // Êñ∞Â¢ûÊó∂ÔºåÊâçpushÂà∞Êú´Â∞æ
      firebase.database().ref('order').once("value").then(snap => {
        let order = snap.val() || [];
        if (!order.includes(title)) {
          order.push(title);
          firebase.database().ref('order').set(order);
        }
      });
    }

    firebase.database().ref('data/' + title).set(obj);
    closeDataTable();
  }
  window.saveDataTable = saveDataTable;

  document.getElementById("dataTableModal").addEventListener("click",function(e){
    if(e.target === this) closeDataTable();
  });

});
(() => {
  const canvas = document.createElement('canvas');
  canvas.id = 'interactiveSnowCanvas';
  canvas.style.position = 'fixed';
  canvas.style.top = '0';
  canvas.style.left = '0';
  canvas.style.width = '100vw';
  canvas.style.height = '100vh';
  canvas.style.pointerEvents = 'none';
  canvas.style.zIndex = '9999';
  document.body.appendChild(canvas);

  const ctx = canvas.getContext('2d');
  let width, height;

  function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
  }
  resize();
  window.addEventListener('resize', resize);

  function drawHexSnowflake(ctx, x, y, radius, rotation, opacity) {
    const sides = 6;
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(rotation);
    const grad = ctx.createRadialGradient(0, 0, radius * 0.3, 0, 0, radius);
    grad.addColorStop(0, `rgba(255, 255, 255, ${opacity * 0.7})`);
    grad.addColorStop(0.7, `rgba(255, 255, 255, 0.1)`);
    grad.addColorStop(1, 'rgba(255, 255, 255, 0)');
    ctx.fillStyle = grad;
    ctx.shadowColor = `rgba(255, 255, 255, ${opacity * 0.9})`;
    ctx.shadowBlur = radius * 2;
    ctx.beginPath();
    for (let i = 0; i <= sides; i++) {
      const angle = i * Math.PI / 3;
      const r = (i % 2 === 0) ? radius : radius * 0.6;
      ctx.lineTo(r * Math.cos(angle), r * Math.sin(angle));
    }
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  class FancySnowflake {
    constructor() {
      this.reset();
      this.isPopping = false;
      this.popRadius = 0;
      this.popMaxRadius = 30;
      this.popOpacity = 1;
    }
    reset() {
      this.x = Math.random() * width;
      this.y = Math.random() * -height;
      this.radius = Math.random() * 10 + 8;
      this.speedY = Math.random() * 1 + 0.6;
      this.speedX = Math.random() * 0.4 - 0.2;
      this.rotation = Math.random() * Math.PI * 2;
      this.rotationSpeed = (Math.random() * 0.01 + 0.002) * (Math.random() < 0.5 ? 1 : -1);
      this.opacity = Math.random() * 0.5 + 0.5;
      this.amplitude = Math.random() * 10 + 15;
      this.phase = Math.random() * Math.PI * 2;
      this.phaseSpeed = Math.random() * 0.03 + 0.01;
      this.isPopping = false;
      this.popRadius = 0;
      this.popMaxRadius = 30;
      this.popOpacity = 1;
    }
    update() {
      if(this.isPopping) {
        this.popRadius += 1.5;
        this.popOpacity -= 0.05;
        if(this.popOpacity <= 0) this.reset();
        return;
      }
      this.y += this.speedY;
      this.phase += this.phaseSpeed;
      this.x += Math.sin(this.phase) * 0.5 + this.speedX;
      this.rotation += this.rotationSpeed;
      if (this.y > height + this.radius) this.reset();
      if (this.x > width + this.radius) this.x = -this.radius;
      if (this.x < -this.radius) this.x = width + this.radius;
    }
    draw(ctx) {
      if(this.isPopping) {
        ctx.save();
        ctx.beginPath();
        ctx.strokeStyle = `rgba(255,255,255,${this.popOpacity})`;
        ctx.shadowColor = `rgba(255,255,255,${this.popOpacity})`;
        ctx.shadowBlur = this.popRadius * 1.5;
        ctx.lineWidth = 2;
        ctx.arc(this.x, this.y, this.popRadius, 0, Math.PI * 2);
        ctx.stroke();
        ctx.restore();
      } else {
        drawHexSnowflake(ctx, this.x, this.y, this.radius, this.rotation, this.opacity);
      }
    }
    containsPoint(px, py) {
      const dx = px - this.x;
      const dy = py - this.y;
      return dx * dx + dy * dy <= this.radius * this.radius;
    }
    pop() {
      if(this.isPopping) return;
      this.isPopping = true;
      this.popRadius = this.radius;
      this.popOpacity = 1;
    }
  }

  const snowflakes = [];
  const maxFlakes = 130;
  for (let i = 0; i < maxFlakes; i++) {
    snowflakes.push(new FancySnowflake());
  }

  function animate() {
    ctx.clearRect(0, 0, width, height);
    for (const flake of snowflakes) {
      flake.update();
      flake.draw(ctx);
    }
    requestAnimationFrame(animate);
  }
  animate();

  canvas.addEventListener('click', (e) => {
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;
    for(let i = snowflakes.length - 1; i >= 0; i--) {
      const flake = snowflakes[i];
      if(!flake.isPopping && flake.containsPoint(clickX, clickY)) {
        flake.pop();
        break;
      }
    }
});
})();
</script>
</body>
</html>
