<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æµ…æ°´æ¹¾åˆ˜å¾·ä¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    :root {
      --bg-img: url('https://firebasestorage.googleapis.com/v0/b/yuge1031-45725.firebasestorage.app/o/8826455a02017711249cb4ee3f0c3e84.jpg?alt=media&token=b2ee9dc3-d05d-4434-98a2-a1b17b7c784d');
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Microsoft YaHei', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-img) no-repeat center center fixed;
      background-size: cover;
      color: #333;
      min-height: 100vh;
    }
    #mainApp { display: none; }
    #passwordOverlay { display: flex; }
    .edit-box h3 {
      font-size:19px;
      font-weight:600;
      margin-bottom:8px;
      color:#1976d2;
      text-align: center;
    }
    #customTable td {
      padding: 4px 10px;
      text-align: center;
    }
    #customTable input {
      width: 100%;
      min-width: 40px;
      font-size: 15px;
      box-sizing: border-box;
      border: none;
      background: transparent;
      outline: none;
      text-align: center;
      padding: 2px 6px;
    }
    .edit-title-input, .edit-category-select {
      width: 100%;
      box-sizing: border-box;
      font-size: 18px;
      border: 1.5px solid #b8e0ff;
      border-radius: 7px;
      padding: 11px 12px;
      margin-bottom: 6px;
      background: #f8fcff;
      box-shadow: 0 2px 7px #1976d215;
      outline: none;
      transition: border 0.16s;
      text-align: center;
    }
    .edit-category-select, #newCategory, #dataTableCategoryInput {
  font-size: 16px;
  font-weight: bold;
  padding: 10px 16px;
  border-radius: 9px;
  border: 1.5px solid #1976d2;
  background: #f8fcff;
  box-shadow: 0 2px 9px #1976d222;
  outline: none;
  color: #1976d2;
  min-width: 110px;
  margin-bottom: 8px;
  transition: border 0.15s, box-shadow 0.18s;
}
.edit-category-select:focus, #newCategory:focus, #dataTableCategoryInput:focus {
  border: 1.5px solid #1de9b6;
  box-shadow: 0 2px 14px #1de9b644;
}
    main {
      margin: 40px auto;
      max-width: 1200px;
      padding: 32px 18px 30px 18px;
      border-radius: 28px;
      position: relative;
      z-index: 2;
      min-height: 450px;
      box-shadow: 0 8px 36px #1565c01a;
      background: rgba(255,255,255,0.80);
      backdrop-filter: blur(14px) saturate(1.13);
      -webkit-backdrop-filter: blur(14px) saturate(1.13);
    }
    .main-flex {
      display: flex;
      align-items: flex-start;
      gap: 22px;
    }
    .sidebar {
      min-width: 140px;
      max-width: 220px;
      padding: 22px 10px 0 2px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 13px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .filter-btn {
      border-radius: 8px;
      font-size: 15px;
      padding: 11px 0;
      background: #e3f2fd;
      color: #1976d2;
      border: none;
      box-shadow: 0 2px 8px #1976d219;
      cursor: pointer;
      transition: background 0.14s, color 0.12s;
      width: 100%;
      text-align: center;
    }
    .filter-btn.active, .filter-btn:hover {
      background: linear-gradient(90deg,#1a73e8 80%, #1de9b6 100%);
      color: #fff;
    }
    .cat-mgr-btn {
      margin-top: 8px;
      padding: 11px 0;
      font-size: 15px;
      border-radius: 10px;
      background: linear-gradient(90deg,#00e2c9 40%,#1976d2 100%);
      color: #fff;
      font-weight: bold;
      border: none;
      box-shadow: 0 2px 10px #1de9b627;
      cursor: pointer;
      width: 100%;
      transition: background 0.16s;
    }
    .cat-mgr-btn:hover {
      background: linear-gradient(90deg,#1976d2 50%,#26c6da 100%);
    }
    .main-content {
      flex: 1 1 auto;
      min-width: 0;
    }
    .input-group {
      gap: 14px;
      margin-bottom: 34px;
      justify-content: center;
      display: flex;
      flex-wrap: wrap;
      border-radius: 16px;
      padding: 16px 20px;
      background: rgba(255,255,255,0.86);
      backdrop-filter: blur(7px);
      box-shadow: 0 4px 16px #1de9b610;
      align-items: center;
    }
    .input-group input[type="text"] {
      font-size: 17px;
      border-radius: 13px;
      border: 1.5px solid #b8e0ff;
      box-shadow: 0 2px 12px #b3d8f322;
      padding: 13px 15px;
      background: rgba(255,255,255,0.9);
      transition: border .16s;
    }
    .input-group input[type="text"]:focus {
      border: 1.5px solid #1a73e8;
      background: rgba(240,250,255,0.87);
    }
    .input-group button, .input-group select {
      border-radius: 13px;
      font-size: 17px;
      font-weight: bold;
      padding: 13px 22px;
      color: #fff;
      border: none;
      box-shadow: 0 2px 6px #00eaff26;
      cursor: pointer;
      transition: background 0.13s, transform 0.13s;
      background: linear-gradient(90deg, #2196f3 60%, #1de9b6 100%);
      margin-right: 0;
    }
    .input-group select {
  border-radius: 13px;
  font-size: 17px;
  font-weight: bold;
  padding: 13px 22px;
  color: #fff;
  border: none;
  background: linear-gradient(90deg, #2196f3 60%, #1de9b6 100%);
  box-shadow: 0 2px 6px #00eaff26;
  margin-right: 0;
  min-width: 120px;
  height: 48px;           /* è®©selectå’ŒæŒ‰é’®é«˜åº¦ä¸€è‡´ */
  cursor: pointer;
  outline: none;
  appearance: none;       /* ç§»é™¤åŸç”Ÿæ ·å¼ï¼ˆç«ç‹å¯èƒ½ç”¨-moz-appearance:noneï¼‰ */
  transition: background 0.13s, transform 0.13s;
  display: inline-block;
  line-height: 1;         /* è®©æ–‡å­—å±…ä¸­ */
  text-align: center;
  box-sizing: border-box;
}

.input-group select:focus,
.input-group select:hover {
  background: linear-gradient(90deg, #1976d2 60%, #26c6da 100%);
}

.input-group {
  display: flex;
  align-items: center;
  gap: 14px;
}

/* éšè—é»˜è®¤ä¸‹æ‹‰ç®­å¤´ï¼Œè‡ªå®šä¹‰ç®­å¤´å¯é€‰ */
.input-group select::-ms-expand { display: none; }
.input-group select {
  background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="20" width="20" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>');
  background-repeat: no-repeat;
  background-position: right 14px center;
  background-size: 18px 18px;
  padding-right: 38px;
}
    .input-group button:hover {
      background: linear-gradient(90deg, #1976d2 60%, #26c6da 100%);
      transform: translateY(-1px) scale(1.04);
    }
    .category-input-custom {
      display: none;
      margin-left: 8px;
      font-size: 15px;
      border-radius: 7px;
      border: 1.5px solid #b8e0ff;
      background: #f8fcff;
      padding: 9px 10px;
      outline: none;
      width: 110px;
      box-shadow: 0 2px 7px #1976d215;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(290px,1fr));
      gap: 28px 22px;
      width: 100%;
    }
    .item {
      background: rgba(255,255,255,0.66);
      backdrop-filter: blur(8px) saturate(1.15);
      box-shadow: 0 4px 24px #1976d220, 0 1.5px 3px #1565c012;
      border-radius: 18px;
      min-width: 0;
      width: 100%;
      min-height: 110px;
      padding: 18px 12px 26px 12px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: box-shadow 0.14s, transform 0.13s, background 0.18s;
      cursor: pointer;
      position: relative;
    }
    .item:hover {
      box-shadow: 0 8px 28px #2196f330;
      transform: translateY(-2px) scale(1.03);
      background: rgba(236,245,255,0.80);
    }
    .item .title {
      font-weight: bold;
      font-size: 18.5px;
      margin-bottom: 8px;
      text-align: center;
      color: #1565c0;
      word-break: break-all;
    }
    .category-badge {
      display: inline-block;
      background: #1de9b6;
      color: #fff;
      font-size: 13px;
      padding: 2px 11px 3px 11px;
      border-radius: 11px;
      margin-bottom: 9px;
      margin-right: 6px;
      text-align: left;
      letter-spacing: 1px;
      font-weight: 500;
      box-shadow: 0 2px 10px #1de9b627;
    }
    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .actions button {
      border-radius: 9px;
      font-size: 15px;
      padding: 7px 16px;
      font-weight: 500;
      background: linear-gradient(90deg, #1a73e8 70%, #1de9b6 100%);
      color: #fff;
      border: none;
      box-shadow: 0 2px 6px #00eaff26;
      cursor: pointer;
      transition: background 0.13s, transform 0.13s;
    }
    .actions button:hover {
      background: linear-gradient(90deg, #1976d2 60%, #26c6da 100%);
      transform: scale(1.04);
    }
    .edit-modal {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 99;
      background: rgba(33,42,66,0.04);
    }
    .edit-modal.active { display: flex; }
    .edit-box {
      background: rgba(255,255,255,0.98);
      border-radius: 20px;
      box-shadow: 0 8px 38px #1976d225;
      min-width: 320px;
      max-width: 95vw;
      min-height: 220px;
      max-height: 95vh;
      width: auto !important;
      height: auto !important;
      display: flex;
      flex-direction: column;
      gap: 18px;
      overflow: visible !important;
      position: relative;
      padding: 32px 28px 22px 28px;
      transition: width 0.16s, height 0.16s;
    }
    .edit-box h3 {
      font-size:19px;
      font-weight:600;
      margin-bottom:8px;
      color:#1976d2
    }
    .rich-content {
      flex: 1 1 auto;
      min-height: 400px;
      max-height: none;
      width: 100%;
      box-sizing: border-box;
      border:1.5px solid #c5e4ff;
      background:rgba(255,255,255,0.99);
      border-radius:10px;
      font-size:17px;
      padding:13px;
      box-shadow:0 2px 12px #1976d215;
      margin-bottom:10px;
      outline:none;
      line-height:1.6;
      overflow:auto;
      resize: none;
      margin-top: 6px;
    }
    .rich-content:focus { border: 1.5px solid #1a73e8; background: #f8fcff;}
    .rich-content:empty:before { content: "è¯·è¾“å…¥å†…å®¹..."; color: #999;}
    .edit-actions {
      display: flex;
      gap: 16px;
      justify-content: flex-end;
    }
    .edit-actions button {
      padding: 8px 22px;
      border-radius: 9px;
      font-size: 15.5px;
      font-weight: 500;
      background: linear-gradient(90deg, #2196f3 60%, #1de9b6 100%);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.13s;
    }
    .edit-actions button.cancel { background: #b8b8b8; color: #fff;}
    #dataTableBox {
      width: auto !important;
      height: auto !important;
      max-width: 95vw;
      max-height: 95vh;
      overflow: visible !important;
      min-width: 320px;
    }
    #dataTableWrapper {
      overflow-x: auto;
      max-width: 100vw;
      background: #fafcff;
      border: 1.5px solid #b8e0ff;
      border-radius: 8px;
      padding: 7px;
      margin-bottom: 10px;
    }
    #customTable {
      min-width: 900px;
    }
    @media (max-width:900px) {
      main { padding: 4vw 2vw; }
      .main-flex { flex-direction: column; }
      .sidebar { flex-direction: row; gap: 12px; max-width: none; min-width: 0; padding: 7px 0 0 0;}
      .filter-group { flex-direction: row; gap: 9px; }
      .filter-btn, .cat-mgr-btn { width: auto; min-width: 90px; padding: 9px 14px;}
      .cat-mgr-btn { margin-top: 0; }
      .container { gap: 18px 7px; }
      .item { min-width: 130px; }
      .edit-box { min-width: 0; padding: 12px 3vw 10px 3vw;}
    }
    @media (max-width:600px) {
      .edit-box { padding: 7px 1vw 9px 1vw;}
      .input-group { padding: 9px 2vw; }
      .item { padding: 7px 2vw 10px 2vw; }
      main { border-radius: 0; margin: 0; }
      header { border-radius: 0 0 18px 18px; }
      .container { grid-template-columns: 1fr; }
      #dataTableWrapper {
        overflow-x: auto;
        width: 100%;
        max-width: 100vw;
      }
      #customTable {
        min-width: 1000px;
        width: max-content;
      }
      #customTable td {
        padding: 4px 10px;
        text-align: center;
        max-width: 340px;
        white-space: pre-wrap;
        word-break: break-all;
        box-sizing: border-box;
      }
      #customTable input {
        width: 100%;
        min-width: 40px;
        font-size: 15px;
        border: none;
        background: transparent;
        outline: none;
        text-align: center;
        padding: 2px 6px;
        box-sizing: border-box;
      }
    }
    #passwordOverlay {
      position: fixed;
      z-index: 9999;
      width: 100vw;
      height: 100vh;
      top: 0; left: 0;
      background: var(--bg-img) no-repeat center center fixed;
      background-size: cover;
      backdrop-filter: blur(7px) brightness(1.08);
      background-color: rgba(34, 85, 170, 0.11);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background-color 0.4s;
      animation: fadeInBg 1.2s cubic-bezier(.22,.68,.51,1.16);
      padding: 0 16px;
    }
    #passwordOverlay h3 {
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 2px;
      color: #e3f2fd;
      text-shadow: 0 4px 16px #1565c0cc, 0 2px 8px #fff6;
      margin-bottom: 18px;
    }
    #passwordOverlay input, #passwordOverlay button {
      box-shadow: 0 4px 32px rgba(33,150,243,0.15);
      background: rgba(255,255,255,0.85);
      border: 1.5px solid #61aefb;
      border-radius: 10px;
      font-size: 18px;
      margin-bottom: 12px;
      margin-top: 0;
    }
    #passwordOverlay input {
      padding: 10px 16px;
      width: 90vw;
      max-width: 260px;
      min-width: 120px;
    }
    #passwordOverlay button {
      padding: 10px 38px;
      font-size: 18px;
      font-weight: bold;
      background: linear-gradient(90deg, #2196f3 60%, #1de9b6 100%);
      color: #fff;
      border: none;
      box-shadow: 0 2px 16px #00eaff30;
      transition: background 0.18s, transform 0.15s;
      cursor: pointer;
      width: 90vw;
      max-width: 260px;
      min-width: 120px;
    }
    #passwordOverlay button:hover {
      background: linear-gradient(90deg, #1976d2 40%, #26c6da 100%);
      transform: translateY(-1px) scale(1.03);
    }
    #errorHint {
      margin-top: 10px;
      font-size: 16px;
      color: #f44336;
      font-weight: bold;
      text-shadow: 0 2px 8px #fff6;
    }
.cat-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 10px;
  border-radius: 8px;
  transition: background 0.16s;
  margin-bottom: 6px;
  cursor: pointer;
}
.cat-item:hover {
  background: #e3f2fd80;
}
.cat-name {
  flex: 1 1 auto;
  word-break: break-all;
  font-size: 16px;
  color: #1976d2;
  font-weight: 500;
}
.cat-count {
  font-size: 13px;
  color: #666;
  background: #e0f7fa;
  border-radius: 10px;
  padding: 2px 8px;
  margin-right: 4px;
}
.cat-btn {
  background: none;
  border: none;
  font-size: 17px;
  color: #1976d2;
  padding: 3px 8px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.13s;
  margin-left: 2px;
}
.cat-btn:hover {
  background: #e3f2fd;
}
.cat-btn.del {
  color: #e53935;
}
.cat-btn.del:hover {
  background: #ffcdd2;
}
  /* header æ ·å¼å¢å¼ºï¼ˆæ–°åŠ çš„ï¼‰ */
  header {
  position: relative;
  left: 50%;
  width: 100vw;
  min-width: 100vw;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.78);
  box-shadow: 0 6px 24px #1976d215;
  border-radius: 0 0 28px 28px;
  padding: 34px 0 32px 0;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 100;
  box-sizing: border-box;
}
body, html { overflow-x: hidden; }
header span {
  color: #1976d2;
  font-size: 2.4rem;
  font-weight: bold;
  text-shadow: 0 2px 8px #fff, 0 8px 20px #b0e0ff66;
  letter-spacing: 2px;
}
</style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div id="passwordOverlay">
    <h3>è¯·è¾“å…¥è®¿é—®å¯†ç </h3>
    <input type="password" id="accessPassword" placeholder="è¾“å…¥å¯†ç " />
    <button id="enterBtn">è¿›å…¥</button>
    <p id="errorHint" style="display: none;">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</p>
  </div>
  <div id="mainApp">
    <header>
      <span>æµ…æ°´æ¹¾åˆ˜å¾·ä¼</span>
    </header>
    <main>
      <div class="main-flex">
        <aside class="sidebar">
          <div id="categoryFilterGroup" class="filter-group"></div>
          <button type="button" id="openCategoryManagerBtn" class="cat-mgr-btn">åˆ†ç±»ç®¡ç†</button>
        </aside>
        <section class="main-content">
          <div class="input-group">
            <input type="text" id="newItem" placeholder="è¾“å…¥é€‰é¡¹åç§°" />
            <div style="display:flex;align-items:center;">
              <select id="newCategory"></select>
              <input type="text" id="newCategory_customInput" class="category-input-custom" placeholder="è‡ªå®šä¹‰åˆ†ç±»" maxlength="8" />
            </div>
            <button onclick="addItem()">æ·»åŠ é€‰é¡¹</button>
            <button onclick="openDataTableModal()">æ·»åŠ æ•°æ®</button>
            <input type="text" id="searchBox" placeholder="æœç´¢é€‰é¡¹æˆ–å†…å®¹" oninput="searchItems()" />
            <select id="categoryFilter" onchange="filterByCategory()" style="display:none;">
              <option value="">å…¨éƒ¨åˆ†ç±»</option>
            </select>
          </div>
          <div id="itemList" class="container"></div>
        </section>
      </div>
    </main>
    <div id="editModal" class="edit-modal" tabindex="-1">
      <div class="edit-box" id="editBox">
        <h3>ç¼–è¾‘é€‰é¡¹å¡</h3>
        <input class="edit-title-input" id="editTitleInput" placeholder="è¯·è¾“å…¥é€‰é¡¹å¡æ ‡é¢˜" />
        <div style="display:flex;align-items:center;">
          <select class="edit-category-select" id="editCategoryInput"></select>
          <input type="text" id="editCategoryInput_customInput" class="category-input-custom" placeholder="è‡ªå®šä¹‰åˆ†ç±»" maxlength="8" />
        </div>
        <div class="rich-content" id="editContent" contenteditable="true"></div>
        <div class="edit-actions">
          <button onclick="saveEdit()">ä¿å­˜</button>
          <button class="cancel" onclick="closeEdit()">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <div id="dataTableModal" class="edit-modal" tabindex="-1">
      <div class="edit-box" id="dataTableBox">
        <h3>æ·»åŠ æ•°æ®å¡ç‰‡</h3>
        <input class="edit-title-input" id="dataTableTitleInput" placeholder="è¯·è¾“å…¥æ•°æ®å¡ç‰‡æ ‡é¢˜" />
        <div style="display:flex;align-items:center;">
          <select class="edit-category-select" id="dataTableCategoryInput"></select>
          <input type="text" id="dataTableCategoryInput_customInput" class="category-input-custom" placeholder="è‡ªå®šä¹‰åˆ†ç±»" maxlength="8" />
        </div>
        <div id="dataTableWrapper">
          <table id="customTable" border="1" style="border-collapse:collapse;"></table>
        </div>
        <div class="edit-actions">
          <button onclick="saveDataTable()">ä¿å­˜</button>
          <button class="cancel" onclick="closeDataTable()">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <!-- åˆ†ç±»ç®¡ç†å¼¹çª— -->
    <div id="categoryManagerModal" class="edit-modal" tabindex="-1">
      <div class="edit-box" style="min-width:260px;">
        <h3>åˆ†ç±»ç®¡ç†</h3>
        <ul id="categoryList" style="list-style:none;padding:0;margin-bottom:16px;">
        </ul>
        <div style="display:flex;gap:8px;">
          <input type="text" id="newCategoryInput" placeholder="æ–°åˆ†ç±»å" style="flex:1 1 auto;padding:9px 12px;font-size:15px;border-radius:7px;border:1.5px solid #b8e0ff;background:#f8fcff;outline:none;" maxlength="8">
          <button id="addCategoryBtn" style="padding:8px 16px;border-radius:7px;background:linear-gradient(90deg,#1de9b6 30%,#1976d2 100%);color:#fff;border:none;font-size:15px;font-weight:bold;">æ–°å¢</button>
        </div>
        <div class="edit-actions" style="margin-top:18px;">
          <button onclick="closeCategoryManager()">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>
  <script>
document.addEventListener("DOMContentLoaded", function() {

  // åˆ†ç±»ç®¡ç†åŠŸèƒ½ï¼šæŒä¹…åŒ–åˆ°localStorage
  function loadCategoryList(){
    try {
      let local = JSON.parse(localStorage.getItem("CATEGORY_LIST"));
      if(Array.isArray(local) && local.length) return local;
    } catch{}
    return ["ç§‘æŠ€èµ„è®¯","æ•°æ®ç»Ÿè®¡","æˆå‘˜ä¿¡æ¯","å…¶ä»–"];
  }
  function saveCategoryList(){
    localStorage.setItem("CATEGORY_LIST", JSON.stringify(CATEGORY_LIST));
  }
  let CATEGORY_LIST = loadCategoryList();

  // firebaseé…ç½®
  const firebaseConfig = {
    apiKey: "AIzaSyAZFBRN2YfUdSSiCsIy63iMUqwdOqUZO1k",
    authDomain: "yuge1031-45725.firebaseapp.com",
    databaseURL: "https://yuge1031-45725-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "yuge1031-45725",
    storageBucket: "yuge1031-45725.appspot.com",
    messagingSenderId: "131078767676",
    appId: "1:131078767676:web:89418f134456102c9aaf39"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // å¯†ç ç•Œé¢
  const CORRECT_PASSWORD = "qwe96300";
  function checkPassword() {
    const input = document.getElementById("accessPassword").value;
    if (input === CORRECT_PASSWORD) {
      document.getElementById("passwordOverlay").style.display = "none";
      document.getElementById("mainApp").style.display = "block";
    } else {
      document.getElementById("errorHint").style.display = "block";
    }
  }
  document.getElementById("enterBtn").onclick = checkPassword;
  document.getElementById("accessPassword").addEventListener("keydown", function(e){
    if(e.key === "Enter") checkPassword();
window.closeEdit = closeEdit;
window.saveEdit = saveEdit;
window.saveDataTable = saveDataTable;
window.closeDataTable = closeDataTable;
window.openDataTableModal = openDataTableModal;
window.addItem = addItem;
window.searchItems = searchItems;
window.filterByCategory = filterByCategory;
window.openCategoryManager = openCategoryManager;
  });

  // æ•°æ®ç¼“å­˜å’Œæ¸²æŸ“
  let allData = {};
  let allOrder = [];
  let currentCategoryFilter = "";

  const itemList = document.getElementById("itemList");

  function highlightKeyword(str, keyword) {
    if (!keyword) return str;
    const safe = s => s.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
    return str.replace(new RegExp(safe(keyword), 'gi'), m => `<span style="background:#ffe082;color:#d32f2f;border-radius:4px;padding:0 2px;">${m}</span>`);
  }

  function renderAllItems(data, order) {
    itemList.innerHTML = "";
    (order || Object.keys(data)).forEach(name => {
      if (data[name] !== undefined) createItemElement(name, data[name]);
    });
  }

  function getCardCategory(obj) {
    if (typeof obj === "object" && obj.category) return obj.category;
    return "";
  }

  function getCardContent(obj) {
    if (typeof obj === "object" && obj.content !== undefined) return obj.content;
    return obj;
  }

  function createItemElement(itemName, obj = {}) {
    let content = getCardContent(obj);
    let category = getCardCategory(obj);

    const container = document.createElement("div");
    container.className = "item";
    container.dataset.name = itemName;
    container.onclick = () => openEditor(itemName);
    container.addEventListener('click', (e) => {
      if(e.target.tagName === 'BUTTON') e.stopPropagation();
    });

    // åˆ†ç±» badge
    if (category) {
  let catDiv = document.createElement("div");
  catDiv.className = "category-badge";
  catDiv.textContent = category;
  catDiv.style.margin = "0 auto 7px auto";
  catDiv.style.background = "linear-gradient(90deg, #1976d2 65%, #1de9b6 100%)";
  catDiv.style.fontWeight = "bold";
  catDiv.style.fontSize = "15.5px";
  catDiv.style.boxShadow = "0 2px 10px #1565c036";
  catDiv.style.color = "#fff";
  container.appendChild(catDiv);
}

    // æ ‡é¢˜
    const title = document.createElement("div");
    title.className = "title";
    const keyword = document.getElementById("searchBox")?.value.trim();
    if (keyword) {
      title.innerHTML = highlightKeyword(itemName, keyword);
    } else {
      title.textContent = itemName;
    }
    container.appendChild(title);

    // æ“ä½œ
    const actions = document.createElement("div");
    actions.className = "actions";
    actions.innerHTML = `
      <button onclick="openEditor('${itemName}')">ä¿®æ”¹</button>
      <button onclick="deleteItem('${itemName}', event)">åˆ é™¤</button>
    `;
    container.appendChild(actions);

    itemList.appendChild(container);
  }

  // æ¸²æŸ“åˆ†ç±»ä¸‹æ‹‰å’Œç­›é€‰æŒ‰é’®
  function renderCategorySelect(){
    // æ·»åŠ å’Œç¼–è¾‘è¡¨å•é‡Œçš„åˆ†ç±»ä¸‹æ‹‰
    [
      {sel:document.getElementById('newCategory'), inp:document.getElementById('newCategory_customInput')},
      {sel:document.getElementById('editCategoryInput'), inp:document.getElementById('editCategoryInput_customInput')},
      {sel:document.getElementById('dataTableCategoryInput'), inp:document.getElementById('dataTableCategoryInput_customInput')}
    ].forEach(({sel,inp})=>{
      if(!sel) return;
      let old = sel.value;
      sel.innerHTML = `<option value="">é€‰æ‹©åˆ†ç±»</option>` + 
        CATEGORY_LIST.map(c=>`<option value="${c}">${c}</option>`).join('') +
        `<option value="_custom_">è‡ªå®šä¹‰...</option>`;
      sel.value = old || "";
      if(inp) inp.style.display="none";
    });
    // ç­›é€‰åŒºæŒ‰é’®
    let filterGroup = document.getElementById('categoryFilterGroup');
    if(filterGroup){
      filterGroup.innerHTML = `<button class="filter-btn" data-value="">å…¨éƒ¨åˆ†ç±»</button>` +
        CATEGORY_LIST.map(c=>`<button class="filter-btn" data-value="${c}">${c}</button>`).join('');
      let cur = document.getElementById('categoryFilter')?.value || "";
      [...filterGroup.children].forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.value===cur);
        btn.onclick = function(){
          document.getElementById("categoryFilter").value = this.dataset.value;
          filterByCategory();
          [...filterGroup.children].forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
        }
      });
    }
    // åŒæ­¥åŸselectï¼ˆéšè—ï¼Œä¾›ä»£ç å…¼å®¹ï¼‰
    let sel = document.getElementById('categoryFilter');
    if(sel){
      let val = sel.value;
      sel.innerHTML = `<option value="">å…¨éƒ¨åˆ†ç±»</option>`+CATEGORY_LIST.map(c=>`<option value="${c}">${c}</option>`).join('');
      sel.value = val || "";
    }
  }
  renderCategorySelect();

  // ç›‘å¬è‡ªå®šä¹‰åˆ†ç±»è¾“å…¥å’Œåˆ‡æ¢
  [
    {sel:'newCategory',inp:'newCategory_customInput'},
    {sel:'editCategoryInput',inp:'editCategoryInput_customInput'},
    {sel:'dataTableCategoryInput',inp:'dataTableCategoryInput_customInput'}
  ].forEach(({sel,inp})=>{
    let select = document.getElementById(sel);
    let input = document.getElementById(inp);
    select.addEventListener('change',function(){
      if(this.value==="_custom_"){
        input.style.display="";
        input.value="";
        input.focus();
      }else{
        input.style.display="none";
      }
    });
    input.addEventListener('keydown',function(e){
      if(e.key==="Enter"){
        let val = input.value.trim();
        if(val && !CATEGORY_LIST.includes(val)){
          CATEGORY_LIST.push(val);
          saveCategoryList();
          renderCategorySelect();
        }
        select.value = val;
        input.style.display="none";
      }
    });
  });

  // åˆ†ç±»ç®¡ç†å¼¹çª—
  document.getElementById("openCategoryManagerBtn").onclick = openCategoryManager;
  function openCategoryManager(){
    renderCategoryManager();
    document.getElementById("categoryManagerModal").classList.add("active");
  }
  function closeCategoryManager(){
    document.getElementById("categoryManagerModal").classList.remove("active");
  }
window.closeCategoryManager = closeCategoryManager;
  function renderCategoryManager() {
    let ul = document.getElementById("categoryList");
    ul.innerHTML = "";
    CATEGORY_LIST.forEach((cat, idx) => {
      // ç»Ÿè®¡åˆ†ç±»ä¸‹æ•°æ®æ•°é‡
      let count = 0;
      for (let key in allData) {
        if (allData[key].category === cat) count++;
      }

      let li = document.createElement("li");
      li.className = "cat-item";

      // åˆ†ç±»åå’Œæ•°é‡
      let nameSpan = document.createElement("span");
      nameSpan.className = "cat-name";
      nameSpan.textContent = cat;

      let countSpan = document.createElement("span");
      countSpan.className = "cat-count";
      countSpan.textContent = count;

      li.appendChild(nameSpan);
      li.appendChild(countSpan);

      // é‡å‘½åæŒ‰é’®
      let renameBtn = document.createElement("button");
      renameBtn.className = "cat-btn";
      renameBtn.title = "é‡å‘½å";
      renameBtn.innerHTML = "âœï¸";
      renameBtn.onclick = function (e) {
        e.stopPropagation();
        let val = prompt("é‡å‘½åä¸ºï¼š", cat);
        if (!val || val === cat || CATEGORY_LIST.includes(val)) return;
        for (let key in allData) {
          if (allData[key].category === cat) {
            db.ref('data/' + key).update({ category: val });
          }
        }
        CATEGORY_LIST[idx] = val;
        saveCategoryList();
        renderCategoryManager();
        renderCategorySelect();
      };
      li.appendChild(renameBtn);

      // åˆ é™¤æŒ‰é’®
      let delBtn = document.createElement("button");
      delBtn.className = "cat-btn del";
      delBtn.title = "åˆ é™¤";
      delBtn.innerHTML = "ğŸ—‘ï¸";
      delBtn.onclick = function (e) {
        e.stopPropagation();
        if (!confirm(`åˆ é™¤åˆ†ç±»â€œ${cat}â€åï¼Œç›¸å…³æ•°æ®çš„åˆ†ç±»å°†è¢«æ¸…ç©ºã€‚ç¡®å®šï¼Ÿ`)) return;
        for (let key in allData) {
          if (allData[key].category === cat) {
            db.ref('data/' + key).update({ category: "" });
          }
        }
        CATEGORY_LIST.splice(idx, 1);
        saveCategoryList();
        renderCategoryManager();
        renderCategorySelect();
      };
      li.appendChild(delBtn);

      ul.appendChild(li);
    });
  }
  document.getElementById("addCategoryBtn").onclick = function(){
    let val = document.getElementById("newCategoryInput").value.trim();
    if(val && !CATEGORY_LIST.includes(val)){
      CATEGORY_LIST.push(val);
      saveCategoryList();
      renderCategoryManager();
      renderCategorySelect();
      document.getElementById("newCategoryInput").value="";
    }
  }

  // æ–°å¢ item æ”¯æŒåˆ†ç±»ï¼ˆå«è‡ªå®šä¹‰ï¼‰
  function addItem() {
    const name = document.getElementById("newItem").value.trim();
    let catSel = document.getElementById("newCategory");
    let cat = catSel.value;
    if(cat === "_custom_"){
      cat = document.getElementById("newCategory_customInput").value.trim();
      if(cat && !CATEGORY_LIST.includes(cat)){
        CATEGORY_LIST.push(cat); saveCategoryList(); renderCategorySelect();
      }
    }
    if (!name) return alert("è¯·è¾“å…¥åç§°");
    db.ref('data/' + name).once("value").then(snapshot => {
      if (snapshot.exists()) return alert("è¯¥é€‰é¡¹å·²å­˜åœ¨ï¼");
      db.ref('data/' + name).set({ content: "", category: cat });
      db.ref('order').once("value").then(snap => {
        const order = snap.val() || [];
        order.push(name);
        db.ref('order').set(order);
      });
      document.getElementById("newItem").value = "";
      catSel.value = "";
      document.getElementById("newCategory_customInput").style.display="none";
    });
  }

  window.openEditor = openEditor;
  function deleteItem(name, e) {
    e.stopPropagation();
    if (!confirm("ç¡®è®¤åˆ é™¤ï¼Ÿ")) return;
    db.ref('data/' + name).remove();
    db.ref('order').once("value").then(snap => {
      const order = (snap.val() || []).filter(n => n !== name);
      db.ref('order').set(order);
    });
  }
  window.deleteItem = deleteItem;

  // ç¼–è¾‘å¼¹çª—é€»è¾‘
  let currentEditName = "";

  function openEditor(name) {
  db.ref('data/' + name).once("value").then(snapshot => {
    let data = snapshot.val();
    let content, category;

    // ä¿®æ­£ï¼šåˆ¤æ–­ content å­—æ®µæ˜¯å¦ä¸ºè¡¨æ ¼
    if (typeof data === "object" && typeof data.content === "string" && data.content.startsWith("<table")) {
      openDataTableModal(name, data.content); // ç›´æ¥æ‰“å¼€æ•°æ®è¡¨æ ¼å¼¹çª—
      return;
    }

    if (typeof data === "object") {
      content = data.content || "";
      category = data.category || "";
    } else {
      content = data || "";
      category = "";
    }

    currentEditName = name;
    document.getElementById("editTitleInput").value = name;
    document.getElementById("editCategoryInput").value = category || "";
    document.getElementById("editCategoryInput_customInput").style.display="none";
    document.getElementById("editContent").innerHTML = content;
    document.getElementById("editModal").classList.add("active");
    setTimeout(() => {
      document.getElementById("editTitleInput").focus();
    }, 100);
  });
}
  function closeEdit() {
    document.getElementById("editModal").classList.remove("active");
  }
  function saveEdit() {
    const newTitle = document.getElementById("editTitleInput").value.trim();
    let catSel = document.getElementById("editCategoryInput");
    let newCategory = catSel.value;
    if(newCategory==="_custom_"){
      newCategory = document.getElementById("editCategoryInput_customInput").value.trim();
      if(newCategory && !CATEGORY_LIST.includes(newCategory)){
        CATEGORY_LIST.push(newCategory); saveCategoryList(); renderCategorySelect();
      }
    }
    const content = document.getElementById("editContent").innerHTML;
    if (!newTitle) return alert("æ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼");
    let obj = { content, category: newCategory };
    if (newTitle !== currentEditName) {
      db.ref('data/' + currentEditName).remove();
      db.ref('data/' + newTitle).set(obj);
      db.ref('order').once("value").then(snap => {
        const order = (snap.val() || []).map(n => n === currentEditName ? newTitle : n);
        db.ref('order').set(order);
      });
    } else {
      db.ref('data/' + currentEditName).set(obj);
    }
    closeEdit();
  }
  document.addEventListener('keydown', function(e){
    if(document.getElementById("editModal").classList.contains("active")) {
      if(e.key==="Escape") closeEdit();
    }
  });
  document.getElementById("editModal").addEventListener("click", function(e){
    if(e.target === this) closeEdit();
  });

  // æœç´¢
  function searchItems() {
    const keyword = document.getElementById("searchBox").value.trim().toLowerCase();
    let categorySelected = document.getElementById("categoryFilter").value;
    let filtered = {};
    for (let k of allOrder) {
      let obj = allData[k];
      let category = getCardCategory(obj);
      let content = getCardContent(obj) || "";
      if (
        (!categorySelected || category === categorySelected) &&
        (
          k.toLowerCase().includes(keyword) ||
          (typeof content === "string" && content.toLowerCase().includes(keyword))
        )
      ) {
        filtered[k] = obj;
      }
    }
    renderAllItems(filtered, Object.keys(filtered));
    if (Object.keys(filtered).length === 0) {
      itemList.innerHTML = `<div style="grid-column: 1/-1;text-align:center;font-size:1.15em;padding:48px 0;color:#1976d2a0;">
        æœªæ‰¾åˆ°ç›¸å…³å†…å®¹ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯
      </div>`;
    }
  }

  // åˆ†ç±»ç­›é€‰
  function filterByCategory() {
    const selected = document.getElementById("categoryFilter").value;
    currentCategoryFilter = selected;
    let keyword = document.getElementById("searchBox").value.trim().toLowerCase();
    if (!selected && !keyword) {
      renderAllItems(allData, allOrder);
      return;
    }
    let filtered = {};
    for (let k of allOrder) {
      let obj = allData[k];
      let category = getCardCategory(obj);
      let content = getCardContent(obj) || "";
      if (
        (!selected || category === selected) &&
        (!keyword || k.toLowerCase().includes(keyword) ||
         (typeof content === "string" && content.toLowerCase().includes(keyword)))
      ) {
        filtered[k] = obj;
      }
    }
    renderAllItems(filtered, Object.keys(filtered));
    if (Object.keys(filtered).length === 0) {
      itemList.innerHTML = `<div style="grid-column: 1/-1;text-align:center;font-size:1.15em;padding:48px 0;color:#1976d2a0;">
        æœªæ‰¾åˆ°ç›¸å…³å†…å®¹ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯
      </div>`;
    }
  }

  db.ref().on("value", snapshot => {
    const val = snapshot.val() || {};
    allData = val.data || {};
    allOrder = val.order || Object.keys(allData);
    renderCategorySelect();
    if (currentCategoryFilter || document.getElementById("searchBox").value.trim()) {
      filterByCategory();
    } else {
      renderAllItems(allData, allOrder);
    }
  });

  new Sortable(itemList, {
    animation: 150,
    delay: 2000,
    delayOnTouchOnly: true,
    touchStartThreshold: 3,
    onEnd: function () {
      const newOrder = [...itemList.children].map(div => div.dataset.name);
      db.ref('order').set(newOrder);
    }
  });

  // æ•°æ®è¡¨å¼¹çª—å’Œè‡ªåŠ¨æ±‚å’Œï¼ˆä¸å¡å…‰æ ‡ï¼‰
  let currentDataTableTitle = "";

  function openDataTableModal(name = "", tableHtml = "") {
    document.getElementById("dataTableTitleInput").value = name || "";
    currentDataTableTitle = name || "";
    let cat = "";
    if (name) {
      db.ref('data/' + name).once("value").then(snapshot => {
        let val = snapshot.val();
        if (typeof val === "object" && val.category) {
          document.getElementById("dataTableCategoryInput").value = val.category;
        } else {
          document.getElementById("dataTableCategoryInput").value = "";
        }
      });
    } else {
      document.getElementById("dataTableCategoryInput").value = "";
    }

    let dataArr = [];
    if (tableHtml) {
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = tableHtml;
      const rows = tempDiv.querySelectorAll("tr");
      rows.forEach(tr => {
        let rowArr = [];
        tr.querySelectorAll("td").forEach(td => {
          rowArr.push((td.textContent || '').replace(/"/g, '&quot;'));
        });
        dataArr.push(rowArr);
      });
    } else {
      for(let i=0;i<10;i++){
        let rowArr = [];
        for(let j=0;j<15;j++) rowArr.push('');
        dataArr.push(rowArr);
      }
    }
    buildTable(dataArr);
    document.getElementById("dataTableModal").classList.add("active");
    document.getElementById("dataTableCategoryInput_customInput").style.display="none";
  }
  function buildTable(arr) {
    const colCount = arr[0]?.length || 0;
    let html = "";
    for (let i=0; i<arr.length; i++) {
      html += "<tr>";
      for (let j=0; j<colCount; j++) {
        html += `<td><input type="text" value="${arr[i][j].replace(/"/g,'&quot;')}" oninput="updateTableSumRow()" /></td>`;
      }
      html += "</tr>";
    }
    document.getElementById("customTable").innerHTML = html;
    updateTableSumRow();
  }
  window.updateTableSumRow = function() {
    const trs = document.querySelectorAll("#customTable tr");
    let arr = [];
    let colCount = 0;
    trs.forEach(tr => {
      let row = [];
      tr.querySelectorAll('td input').forEach(inp => row.push(inp.value));
      if (row.length > colCount) colCount = row.length;
      arr.push(row);
    });
    arr = arr.map(row => {
      while(row.length < colCount) row.push("");
      return row;
    });
    // è®¡ç®—å„åˆ—å’Œ
    let sumArr = [];
    for (let j=0;j<colCount;j++) {
      let sum = 0, isNumberCol = false;
      for (let i=0;i<arr.length;i++) {
        let val = arr[i][j];
        let num = parseFloat(val);
        if (!isNaN(num) && val !== "") {
          sum += num;
          isNumberCol = true;
        }
      }
      sumArr[j] = isNumberCol ? sum : "";
    }
    // æ±‚å’Œè¡Œæ¸²æŸ“
    let sumTr = document.getElementById("sumRow");
    if (!sumTr) {
      sumTr = document.createElement("tr");
      sumTr.id = "sumRow";
      sumTr.style.background = "#e3f2fd";
      sumTr.style.fontWeight = "bold";
      document.getElementById("customTable").appendChild(sumTr);
    }
    let sumHtml = "";
    for (let j=0;j<colCount;j++) {
      sumHtml += `<td>${sumArr[j]!=="" ? sumArr[j] : ""}</td>`;
    }
    sumTr.innerHTML = sumHtml;
  };

  function closeDataTable(){
    document.getElementById("dataTableModal").classList.remove("active");
  }

  function saveDataTable(){
    const titleInput = document.getElementById("dataTableTitleInput");
    let title = titleInput.value.trim();
    let catSel = document.getElementById("dataTableCategoryInput");
    let cat = catSel.value;
    if(cat === "_custom_"){
      cat = document.getElementById("dataTableCategoryInput_customInput").value.trim();
      if(cat && !CATEGORY_LIST.includes(cat)){
        CATEGORY_LIST.push(cat); saveCategoryList(); renderCategorySelect();
      }
    }
    if(!title) return alert("æ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼");
    // è·å–è¡¨æ ¼å†…å®¹
    const trs = document.querySelectorAll("#customTable tr");
    let arr = [];
    trs.forEach((tr, idx) => {
      if (tr.id === "sumRow") return;
      let row = [];
      tr.querySelectorAll('td input').forEach(inp=>row.push(inp.value));
      arr.push(row);
    });
    let tableHtml = "<table border='1' style='border-collapse:collapse'>";
    arr.forEach(row=>{
      tableHtml += "<tr>";
      row.forEach(cell=>{
        tableHtml += `<td style="min-width:40px;padding:3px 8px">${cell?cell:""}</td>`;
      });
      tableHtml += "</tr>";
    });
    tableHtml += "</table>";

    let obj = { content: tableHtml, category: cat };

    if (title !== currentDataTableTitle && currentDataTableTitle) {
      // é‡å‘½åï¼Œåˆ é™¤æ—§ key å¹¶æ›´æ–° order
      firebase.database().ref('data/' + currentDataTableTitle).remove();
      firebase.database().ref('order').once("value").then(snap => {
        let order = snap.val() || [];
        order = order.map(v => v === currentDataTableTitle ? title : v);
        firebase.database().ref('order').set(order);
      });
    }

    firebase.database().ref('data/' + title).set(obj);
    firebase.database().ref('order').once("value").then(snap => {
      let order = snap.val() || [];
      if (!order.includes(title)) {
        order.push(title);
        firebase.database().ref('order').set(order);
      }
    });

    closeDataTable();
  }

  document.getElementById("dataTableModal").addEventListener("click",function(e){
    if(e.target === this) closeDataTable();
  });

});
</script>
</body>
</html>
