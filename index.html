<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>新加坡种子深科社区</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    :root {
      --bg-img: url('https://firebasestorage.googleapis.com/v0/b/yuge1031-45725.firebasestorage.app/o/8826455a02017711249cb4ee3f0c3e84.jpg?alt=media&token=b2ee9dc3-d05d-4434-98a2-a1b17b7c784d');
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Microsoft YaHei', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-img) no-repeat center center fixed;
      background-size: cover;
      color: #333;
      min-height: 100vh;
    }
.edit-box h3 {
  font-size:19px;
  font-weight:600;
  margin-bottom:8px;
  color:#1976d2;
  text-align: center;
}
#customTable td {
  padding: 4px 10px;
  text-align: center;
}
#customTable input {
  width: 100%;
  min-width: 40px;
  font-size: 15px;
  box-sizing: border-box;
  border: none;
  background: transparent;
  outline: none;
  text-align: center;
  padding: 2px 6px;
}
.edit-title-input {
  width: 100%;
  box-sizing: border-box;
  font-size: 18px;
  font-weight: bold;
  border: 1.5px solid #b8e0ff;
  border-radius: 7px;
  padding: 11px 12px;
  margin-bottom: 6px;
  background: #f8fcff;
  box-shadow: 0 2px 7px #1976d215;
  outline: none;
  transition: border 0.16s;
  text-align: center;  /* 新增这一行 */
}
    #mainApp { display: none; }
    header {
      color: #2075da;
      font-size: 2.1rem;
      font-weight: bold;
      text-shadow: 0 2px 8px #fff, 0 8px 20px #87cdf3a0;
      margin-bottom: 24px;
      padding: 28px 0 24px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      border-radius: 0 0 24px 24px;
      position: relative;
      z-index: 2;
      background: rgba(255,255,255,0.72);
      box-shadow: 0 4px 16px #1976d219;
    }
    main {
      margin: 40px auto;
      max-width: 1200px;
      padding: 32px 18px 30px 18px;
      border-radius: 28px;
      position: relative;
      z-index: 2;
      min-height: 450px;
      box-shadow: 0 8px 36px #1565c01a;
      background: rgba(255,255,255,0.80);
      backdrop-filter: blur(14px) saturate(1.13);
      -webkit-backdrop-filter: blur(14px) saturate(1.13);
    }
    .input-group {
      gap: 14px;
      margin-bottom: 34px;
      justify-content: center;
      display: flex;
      flex-wrap: wrap;
      border-radius: 16px;
      padding: 16px 20px;
      background: rgba(255,255,255,0.86);
      backdrop-filter: blur(7px);
      box-shadow: 0 4px 16px #1de9b610;
    }
    .input-group input[type="text"] {
      font-size: 17px;
      border-radius: 13px;
      border: 1.5px solid #b8e0ff;
      box-shadow: 0 2px 12px #b3d8f322;
      padding: 13px 15px;
      background: rgba(255,255,255,0.9);
      transition: border .16s;
    }
    .input-group input[type="text"]:focus {
      border: 1.5px solid #1a73e8;
      background: rgba(240,250,255,0.87);
    }
    .input-group button {
      border-radius: 13px;
      font-size: 17px;
      background: linear-gradient(90deg, #2196f3 60%, #1de9b6 100%);
      font-weight: bold;
      padding: 13px 22px;
      color: #fff;
      border: none;
      box-shadow: 0 2px 6px #00eaff26;
      cursor: pointer;
      transition: background 0.13s, transform 0.13s;
    }
    .input-group button:hover {
      background: linear-gradient(90deg, #1976d2 60%, #26c6da 100%);
      transform: translateY(-1px) scale(1.04);
    }
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(290px,1fr));
      gap: 28px 22px;
      width: 100%;
    }
    .item {
      background: rgba(255,255,255,0.66);
      backdrop-filter: blur(8px) saturate(1.15);
      box-shadow: 0 4px 24px #1976d220, 0 1.5px 3px #1565c012;
      border-radius: 18px;
      min-width: 0;
      width: 100%;
      min-height: 110px;
      padding: 18px 12px 26px 12px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: box-shadow 0.14s, transform 0.13s, background 0.18s;
      cursor: pointer;
    }
    .item:hover {
      box-shadow: 0 8px 28px #2196f330;
      transform: translateY(-2px) scale(1.03);
      background: rgba(236,245,255,0.80);
    }
    .item .title {
      font-weight: bold;
      font-size: 18.5px;
      margin-bottom: 8px;
      text-align: center;
      color: #1565c0;
      word-break: break-all;
    }
    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .actions button {
      border-radius: 9px;
      font-size: 15px;
      padding: 7px 16px;
      font-weight: 500;
      background: linear-gradient(90deg, #1a73e8 70%, #1de9b6 100%);
      color: #fff;
      border: none;
      box-shadow: 0 2px 6px #00eaff26;
      cursor: pointer;
      transition: background 0.13s, transform 0.13s;
    }
    .actions button:hover {
      background: linear-gradient(90deg, #1976d2 60%, #26c6da 100%);
      transform: scale(1.04);
    }
    /* 编辑弹窗 */
    .edit-modal {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 99;
      background: rgba(33,42,66,0.04);
    }
    .edit-modal.active { display: flex; }

    /* 弹窗自适应内容大小、最大95vw/95vh，不出现内部滚动条 */
    .edit-box {
      background: rgba(255,255,255,0.98);
      border-radius: 20px;
      box-shadow: 0 8px 38px #1976d225;
      min-width: 320px;
      max-width: 95vw;
      min-height: 220px;
      max-height: 95vh;
      width: auto !important;
      height: auto !important;
      display: flex;
      flex-direction: column;
      gap: 18px;
      overflow: visible !important;
      position: relative;
      padding: 32px 28px 22px 28px;
      transition: width 0.16s, height 0.16s;
    }
    .edit-box h3 {
      font-size:19px;
      font-weight:600;
      margin-bottom:8px;
      color:#1976d2
    }
    .edit-title-input {
      width: 100%;
      box-sizing: border-box;
      font-size: 18px;
      font-weight: bold;
      border: 1.5px solid #b8e0ff;
      border-radius: 7px;
      padding: 11px 12px;
      margin-bottom: 6px;
      background: #f8fcff;
      box-shadow: 0 2px 7px #1976d215;
      outline: none;
      transition: border 0.16s;
    }
    .edit-title-input:focus { border: 1.5px solid #1a73e8;}
    .rich-content {
      flex: 1 1 auto;
      min-height: 400px;
      max-height: none;
      width: 100%;
      box-sizing: border-box;
      border:1.5px solid #c5e4ff;
      background:rgba(255,255,255,0.99);
      border-radius:10px;
      font-size:17px;
      padding:13px;
      box-shadow:0 2px 12px #1976d215;
      margin-bottom:10px;
      outline:none;
      line-height:1.6;
      overflow:auto;
      resize: none;
      margin-top: 6px;
    }
    .rich-content:focus { border: 1.5px solid #1a73e8; background: #f8fcff;}
    .rich-content:empty:before { content: "请输入内容..."; color: #999;}
    .edit-actions {
      display: flex;
      gap: 16px;
      justify-content: flex-end;
    }
    .edit-actions button {
      padding: 8px 22px;
      border-radius: 9px;
      font-size: 15.5px;
      font-weight: 500;
      background: linear-gradient(90deg, #2196f3 60%, #1de9b6 100%);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.13s;
    }
    .edit-actions button.cancel { background: #b8b8b8; color: #fff;}

    /* 表格弹窗自适应，不出现内部滚动条 */
    #dataTableBox {
      width: auto !important;
      height: auto !important;
      max-width: 95vw;
      max-height: 95vh;
      overflow: visible !important;
      min-width: 320px;
    }
    #dataTableWrapper {
      overflow: visible !important;
      resize: none !important;
      min-width: 0 !important;
      min-height: 0 !important;
      background: #fafcff;
      border: 1.5px solid #b8e0ff;
      border-radius: 8px;
      padding: 7px;
      margin-bottom: 10px;
    }
    #customTable {
      width: auto;
      min-width: 0;
      max-width: none;
    }
    #customTable td {
      padding: 4px 10px;
    }
    #customTable input {
      width: 100%;
      min-width: 40px;
      font-size: 15px;
      box-sizing: border-box;
      border: none;
      background: transparent;
      outline: none;
      text-align: center;
      padding: 2px 6px;
    }
    @media (max-width:900px) {
      main { padding: 4vw 2vw; }
      .container { gap: 18px 7px; }
      .item { min-width: 130px; }
      .edit-box { min-width: 0; padding: 12px 3vw 10px 3vw;}
    }
    @media (max-width:600px) {
      .edit-box { padding: 7px 1vw 9px 1vw;}
      .input-group { padding: 9px 2vw; }
      .item { padding: 7px 2vw 10px 2vw; }
      main { border-radius: 0; margin: 0; }
      header { border-radius: 0 0 18px 18px; }
      .container { grid-template-columns: 1fr; }
      #dataTableWrapper { max-width:98vw; }
    }
    #passwordOverlay {
      position: fixed;
      z-index: 9999;
      width: 100vw;
      height: 100vh;
      top: 0; left: 0;
      background: var(--bg-img) no-repeat center center fixed;
      background-size: cover;
      backdrop-filter: blur(7px) brightness(1.08);
      background-color: rgba(34, 85, 170, 0.11);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background-color 0.4s;
      animation: fadeInBg 1.2s cubic-bezier(.22,.68,.51,1.16);
      padding: 0 16px;
    }
    #passwordOverlay h3 {
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 2px;
      color: #e3f2fd;
      text-shadow: 0 4px 16px #1565c0cc, 0 2px 8px #fff6;
      margin-bottom: 18px;
    }
    #passwordOverlay input, #passwordOverlay button {
      box-shadow: 0 4px 32px rgba(33,150,243,0.15);
      background: rgba(255,255,255,0.85);
      border: 1.5px solid #61aefb;
      border-radius: 10px;
      font-size: 18px;
      margin-bottom: 12px;
      margin-top: 0;
    }
    #passwordOverlay input {
      padding: 10px 16px;
      width: 90vw;
      max-width: 260px;
      min-width: 120px;
    }
    #passwordOverlay button {
      padding: 10px 38px;
      font-size: 18px;
      font-weight: bold;
      background: linear-gradient(90deg, #2196f3 60%, #1de9b6 100%);
      color: #fff;
      border: none;
      box-shadow: 0 2px 16px #00eaff30;
      transition: background 0.18s, transform 0.15s;
      cursor: pointer;
      width: 90vw;
      max-width: 260px;
      min-width: 120px;
    }
    #passwordOverlay button:hover {
      background: linear-gradient(90deg, #1976d2 40%, #26c6da 100%);
      transform: translateY(-1px) scale(1.03);
    }
    #errorHint {
      margin-top: 10px;
      font-size: 16px;
      color: #f44336;
      font-weight: bold;
      text-shadow: 0 2px 8px #fff6;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div id="passwordOverlay">
    <h3>请输入访问密码</h3>
    <input type="password" id="accessPassword" placeholder="输入密码" />
    <button onclick="checkPassword()">进入</button>
    <p id="errorHint" style="display: none;">密码错误，请重试</p>
  </div>
  <div id="mainApp">
    <header>
      <span>新加坡种子深科社区</span>
    </header>
    <main>
      <div class="input-group">
        <input type="text" id="newItem" placeholder="输入选项名称" />
        <button onclick="addItem()">添加选项</button>
        <button onclick="openDataTableModal()">添加数据</button>
        <input type="text" id="searchBox" placeholder="搜索选项或内容" oninput="searchItems()" />
      </div>
      <div id="itemList" class="container"></div>
    </main>
    <!-- 编辑弹窗 -->
    <div id="editModal" class="edit-modal" tabindex="-1">
      <div class="edit-box" id="editBox">
        <h3>编辑选项卡</h3>
        <input class="edit-title-input" id="editTitleInput" placeholder="请输入选项卡标题" />
        <div class="rich-content" id="editContent" contenteditable="true"></div>
        <div class="edit-actions">
          <button onclick="saveEdit()">保存</button>
          <button class="cancel" onclick="closeEdit()">取消</button>
        </div>
      </div>
    </div>
    <!-- 表格弹窗 -->
    <div id="dataTableModal" class="edit-modal" tabindex="-1">
      <div class="edit-box" id="dataTableBox">
        <h3>添加数据卡片</h3>
        <input class="edit-title-input" id="dataTableTitleInput" placeholder="请输入数据卡片标题" />
        <div id="dataTableWrapper">
          <table id="customTable" border="1" style="border-collapse:collapse;">
            <!-- JS插入表格内容 -->
          </table>
        </div>
        <div class="edit-actions">
          <button onclick="saveDataTable()">保存</button>
          <button class="cancel" onclick="closeDataTable()">取消</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // firebase配置
    const firebaseConfig = {
      apiKey: "AIzaSyAZFBRN2YfUdSSiCsIy63iMUqwdOqUZO1k",
      authDomain: "yuge1031-45725.firebaseapp.com",
      databaseURL: "https://yuge1031-45725-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "yuge1031-45725",
      storageBucket: "yuge1031-45725.appspot.com",
      messagingSenderId: "131078767676",
      appId: "1:131078767676:web:89418f134456102c9aaf39"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 密码逻辑
    const CORRECT_PASSWORD = "qwe96300";
    function checkPassword() {
      const input = document.getElementById("accessPassword").value;
      if (input === CORRECT_PASSWORD) {
        document.getElementById("passwordOverlay").style.display = "none";
        document.getElementById("mainApp").style.display = "block";
      } else {
        document.getElementById("errorHint").style.display = "block";
      }
    }
    document.getElementById("accessPassword").addEventListener("keydown", function(e){
      if(e.key === "Enter") checkPassword();
    });

    // 选项卡功能
    const itemList = document.getElementById("itemList");
    function renderAllItems(data, order) {
      itemList.innerHTML = "";
      (order || Object.keys(data)).forEach(name => {
        if (data[name] !== undefined) createItemElement(name, data[name]);
      });
    }
    function createItemElement(itemName, content = "") {
      const container = document.createElement("div");
      container.className = "item";
      container.dataset.name = itemName;
      container.onclick = () => openEditor(itemName);
      container.addEventListener('click', (e) => {
        if(e.target.tagName === 'BUTTON') e.stopPropagation();
      });
      const title = document.createElement("div");
      title.className = "title";
      title.textContent = itemName;
      const actions = document.createElement("div");
      actions.className = "actions";
      actions.innerHTML = `
        <button onclick="openEditor('${itemName}')">修改</button>
        <button onclick="deleteItem('${itemName}', event)">删除</button>
      `;
      container.appendChild(title);
      container.appendChild(actions);
      itemList.appendChild(container);
    }
    function addItem() {
      const name = document.getElementById("newItem").value.trim();
      if (!name) return alert("请输入名称");
      db.ref('data/' + name).once("value").then(snapshot => {
        if (snapshot.exists()) return alert("该选项已存在！");
        db.ref('data/' + name).set("");
        db.ref('order').once("value").then(snap => {
          const order = snap.val() || [];
          order.push(name);
          db.ref('order').set(order);
        });
        document.getElementById("newItem").value = "";
      });
    }
    function deleteItem(name, e) {
      e.stopPropagation();
      if (!confirm("确认删除？")) return;
      db.ref('data/' + name).remove();
         db.ref('order').once("value").then(snap => {
        const order = (snap.val() || []).filter(n => n !== name);
        db.ref('order').set(order);
      });
    }

    // ============ 优化后弹窗逻辑 ============

    let currentEditName = "";

    function openEditor(name) {
      db.ref('data/' + name).once("value").then(snapshot => {
        const content = snapshot.val() || "";
        currentEditName = name;

        // 如果是表格内容，弹表格弹窗并自动回显内容
        if (content.startsWith("<table")) {
          openDataTableModal(name, content);
        } else {
          document.getElementById("editTitleInput").value = name;
          document.getElementById("editContent").innerHTML = content;
          document.getElementById("editModal").classList.add("active");
          setTimeout(() => {
            document.getElementById("editTitleInput").focus();
          }, 100);
        }
      });
    }

    function closeEdit() {
      document.getElementById("editModal").classList.remove("active");
    }
    function saveEdit() {
      const newTitle = document.getElementById("editTitleInput").value.trim();
      const content = document.getElementById("editContent").innerHTML;
      if (!newTitle) return alert("标题不能为空！");
      if (newTitle !== currentEditName) {
        db.ref('data/' + currentEditName).remove();
        db.ref('data/' + newTitle).set(content);
        db.ref('order').once("value").then(snap => {
          const order = (snap.val() || []).map(n => n === currentEditName ? newTitle : n);
          db.ref('order').set(order);
        });
      } else {
        db.ref('data/' + currentEditName).set(content);
      }
      closeEdit();
    }
    document.addEventListener('keydown', function(e){
      if(document.getElementById("editModal").classList.contains("active")) {
        if(e.key==="Escape") closeEdit();
      }
    });
    document.getElementById("editModal").addEventListener("click", function(e){
      if(e.target === this) closeEdit();
    });

    function searchItems() {
      const keyword = document.getElementById("searchBox").value.trim().toLowerCase();
            db.ref('data').once("value").then(snap => {
        const data = snap.val() || {};
        db.ref('order').once("value").then(orderSnap => {
          const order = orderSnap.val() || Object.keys(data);
          const filtered = {};
          for (let k of order) {
            if (k.toLowerCase().includes(keyword) || (data[k] && data[k].toLowerCase().includes(keyword))) {
              filtered[k] = data[k];
            }
          }
          renderAllItems(filtered, Object.keys(filtered));
        });
      });
    }

    db.ref().on("value", snapshot => {
      const val = snapshot.val() || {};
      renderAllItems(val.data || {}, val.order || []);
    });

    new Sortable(itemList, {
      animation: 150,
      onEnd: function () {
        const newOrder = [...itemList.children].map(div => div.dataset.name);
        db.ref('order').set(newOrder);
      }
    });

    // ============ 支持表格弹窗自适应并自动“回显”内容 ============

    function openDataTableModal(name = "", tableHtml = "") {
      document.getElementById("dataTableTitleInput").value = name || "";
      let html = "";

      if (tableHtml) {
        // 回显: 解析HTML表格转回input
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = tableHtml;
        const rows = tempDiv.querySelectorAll("tr");
        rows.forEach(tr => {
          html += "<tr>";
          tr.querySelectorAll("td").forEach(td => {
            html += `<td><input type="text" value="${(td.textContent || '').replace(/"/g, '&quot;')}" /></td>`;
          });
          html += "</tr>";
        });
      } else {
        // 新建: 默认10x15空表格
        for(let i=0;i<10;i++){
          html += "<tr>";
          for(let j=0;j<15;j++){
            html += `<td><input type="text" /></td>`;
          }
          html += "</tr>";
        }
      }
      document.getElementById("customTable").innerHTML = html;
      document.getElementById("dataTableModal").classList.add("active");
    }

    function closeDataTable(){
      document.getElementById("dataTableModal").classList.remove("active");
    }

    function saveDataTable(){
      const title = document.getElementById("dataTableTitleInput").value.trim();
      if(!title) return alert("标题不能为空！");
      // 读取表格内容为二维数组
      const rows = document.querySelectorAll("#customTable tr");
      let arr = [];
      rows.forEach(tr=>{
        let row = [];
        tr.querySelectorAll('td input').forEach(inp=>row.push(inp.value));
        arr.push(row);
      });
      // 转HTML表格字符串保存
      let tableHtml = "<table border='1' style='border-collapse:collapse'>";
      arr.forEach(row=>{
        tableHtml += "<tr>";
        row.forEach(cell=>{
          tableHtml += `<td style="min-width:40px;padding:3px 8px">${cell?cell:""}</td>`;
        });
        tableHtml += "</tr>";
      });
      tableHtml += "</table>";

      firebase.database().ref('data/' + title).set(tableHtml);
      firebase.database().ref('order').once("value").then(snap => {
        let order = snap.val() || [];
        if (!order.includes(title)) {
          order.push(title);
          firebase.database().ref('order').set(order);
        }
      });
      closeDataTable();
    }

    document.getElementById("dataTableModal").addEventListener("click",function(e){
      if(e.target === this) closeDataTable();
    });

  </script>
</body>
</html>


